{"id":"NetworkView-07b","title":"SLB-01 Builder UI shell + block model","description":"Scope\n- Build the Include / Also include / Exclude block strip.\n- Define block data model + ordering rules.\n- Clear query action.\n\nAcceptance\n- Include block exists by default.\n- Add/edit/remove blocks updates UI state.\n- Reordering is allowed, but Exclude applies last (UI reflects rule).\n","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-25T20:58:07.418566Z","updated_at":"2025-12-25T20:58:07.418566Z","dependencies":[{"issue_id":"NetworkView-07b","depends_on_id":"NetworkView-1tt","type":"parent-child","created_at":"2025-12-25T20:58:07.850444Z","created_by":"daemon"}],"comments":[{"id":19,"issue_id":"NetworkView-07b","author":"home","text":"Design mockup available at public/design/index.html (served at /design/). May need edits to align with spec before wiring into app.","created_at":"2025-12-25T21:52:33Z"}]}
{"id":"NetworkView-0iu","title":"Phase 3: Add “Copy evidence note” (plain text for Word appendix)","description":"Phase: Phase 3 — Snapshot export + MapBuilder hand-off (3–7 days)\nSection: snapshot export\nSource: plan.md","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-25T15:55:23.293616Z","updated_at":"2025-12-25T16:04:03.910765Z","labels":["phase-3"],"dependencies":[{"issue_id":"NetworkView-0iu","depends_on_id":"NetworkView-wu5","type":"parent-child","created_at":"2025-12-25T16:04:04.331735Z","created_by":"daemon"}]}
{"id":"NetworkView-0tu","title":"SLB-06 Accessibility + usability pass","description":"Scope\n- Ensure keyboard focusable controls and clear labels/tooltips.\n- Avoid tiny hit targets.\n\nAcceptance\n- Usable with keyboard and trackpad.\n","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-25T20:58:10.748665Z","updated_at":"2025-12-25T20:58:10.748665Z","dependencies":[{"issue_id":"NetworkView-0tu","depends_on_id":"NetworkView-1tt","type":"parent-child","created_at":"2025-12-25T20:58:11.179274Z","created_by":"daemon"}]}
{"id":"NetworkView-0vm","title":"Phase 2: Implement filter chips (clip/mode/operator/time band) and “Clear all”","description":"Phase: Phase 2 — Map Viewer MVP (route lines + clip + filters + linked table) (5–10 days)\nSection: UI layout and patterns\nSource: plan.md","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-25T15:55:17.76398Z","updated_at":"2025-12-25T16:04:18.014734Z","labels":["phase-2"],"dependencies":[{"issue_id":"NetworkView-0vm","depends_on_id":"NetworkView-p57","type":"parent-child","created_at":"2025-12-25T16:04:18.475821Z","created_by":"daemon"}]}
{"id":"NetworkView-191","title":"DuckDB spatial init: set home/extension directory","description":"DuckDB-WASM spatial extension fails in browser due to missing /home/web_user. Need to set home_directory/extension_directory before LOAD/INSTALL.","acceptance_criteria":"DuckDB init no longer errors on home_directory; spatial extension attempts succeed or fail gracefully.","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-12-25T20:09:03.025785Z","updated_at":"2025-12-25T20:10:08.890812Z","closed_at":"2025-12-25T20:10:08.890812Z","close_reason":"Closed","comments":[{"id":12,"issue_id":"NetworkView-191","author":"home","text":"Added home_directory/extension_directory setup before spatial LOAD/INSTALL in DuckDB init. Tests: npm test -- --run.","created_at":"2025-12-25T20:09:34Z"}]}
{"id":"NetworkView-1ew","title":"Phase 3: Export PNG snapshot with","description":"Phase: Phase 3 — Snapshot export + MapBuilder hand-off (3–7 days)\nSection: snapshot export\nSource: plan.md\nDetails:\n- title (user editable)\n- legend\n- scope chips printed (clip + mode + operator + time band)\n- date/time generated + dataset version","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-25T15:55:23.039242Z","updated_at":"2025-12-25T16:04:04.559946Z","labels":["phase-3"],"dependencies":[{"issue_id":"NetworkView-1ew","depends_on_id":"NetworkView-wu5","type":"parent-child","created_at":"2025-12-25T16:04:05.025137Z","created_by":"daemon"}]}
{"id":"NetworkView-1j5","title":"SLB-02 Curated operator list + templates","description":"Scope\n- Implement 4 starter templates (routes near a place, in an area, near a place within an area, in an area excluding operator).\n- Curate operator verbs: Near point, Touches boundary.\n\nAcceptance\n- Templates populate blocks correctly.\n- Templates reduce clicks and are discoverable.\n\nTemplate source should be driven by the Python runner so updates don’t require UI rewrites; design for future user-defined templates.\n","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-25T20:58:08.126793Z","updated_at":"2025-12-25T22:03:38.701175Z","dependencies":[{"issue_id":"NetworkView-1j5","depends_on_id":"NetworkView-1tt","type":"parent-child","created_at":"2025-12-25T20:58:08.542666Z","created_by":"daemon"}]}
{"id":"NetworkView-1k8","title":"SLB-03 Integrate block actions with Spatial Query state","description":"Scope\n- Translate blocks to internal boolean logic for Spatial Query execution.\n- Ensure live result count updates.\n\nAcceptance\n- Map highlight + table update from builder changes.\n- No boolean terms shown in UI.\n\nAlso covers readable spatial logic sentence/selector; replaces SQ-04 when builder is used.\n\nIntegration should call into the Python runner output (compiled query + template metadata) rather than hard-coded UI logic.\n","status":"in_progress","priority":2,"issue_type":"task","created_at":"2025-12-25T20:58:08.771329Z","updated_at":"2025-12-25T22:32:59.295848Z","dependencies":[{"issue_id":"NetworkView-1k8","depends_on_id":"NetworkView-1tt","type":"parent-child","created_at":"2025-12-25T20:58:09.224989Z","created_by":"daemon"}],"comments":[{"id":20,"issue_id":"NetworkView-1k8","author":"home","text":"Design mockup available at public/design/index.html (served at /design/). May need edits to align with spec before wiring into app.","created_at":"2025-12-25T21:52:34Z"},{"id":28,"issue_id":"NetworkView-1k8","author":"home","text":"Added SLB-03 plumbing for live map/table updates: spatial match-set support in state, filters and map filter now accept serviceIds, and new spatial executor consumes runner output (matchSet or SQL) to update filters. App wires builder changes to applySpatialLogic + re-run filters. Added tests for serviceId filters and execution stub.","created_at":"2025-12-25T22:33:04Z"},{"id":29,"issue_id":"NetworkView-1k8","author":"home","text":"Added DuckDB spatial SQL builder (public/js/spatial/sql.js) + execution path: applySpatialLogic now builds SQL from config spatialLogicSources/CRS when runner doesn’t provide matchSet. Config gains spatialLogicCrs/MetricCrs and sources array. Added tests for spatial SQL + execute. npm test passes.","created_at":"2025-12-25T22:36:48Z"},{"id":30,"issue_id":"NetworkView-1k8","author":"home","text":"Added point-first spatial execution: new Selected Point UI + map click handler stores point, config now includes routes + selected_point sources, and SQL builder supports point sources. applySpatialLogic uses point when building SQL. Tests updated for point source handling.","created_at":"2025-12-25T22:51:51Z"},{"id":31,"issue_id":"NetworkView-1k8","author":"home","text":"Added point marker + radius overlay: map click when picking sets point, updates map layers and label, and radius ring follows builder distance when target is selected_point. Added geometry util for circle polygons and tests.","created_at":"2025-12-25T22:55:22Z"},{"id":32,"issue_id":"NetworkView-1k8","author":"home","text":"Adjusted spatial point overlay layer ordering so marker/radius render above routes (moveLayer after routes added). This should fix point picker visibility.","created_at":"2025-12-25T23:05:33Z"},{"id":33,"issue_id":"NetworkView-1k8","author":"home","text":"Fixed spatial match-set propagation: empty match sets now apply a FALSE filter so map/table clear when no matches. Added serviceIdsActive flag to filters/map and tests for empty-set behavior.","created_at":"2025-12-25T23:10:16Z"},{"id":34,"issue_id":"NetworkView-1k8","author":"home","text":"Fixed spatial query execution: ensure spatial extension loads on demand and wrap WKB geometry with ST_GeomFromWKB via geometryFormat config (routes.parquet). Updated config sources + tests.","created_at":"2025-12-25T23:15:59Z"},{"id":35,"issue_id":"NetworkView-1k8","author":"home","text":"Hardened spatial extension loading: set home/extension dirs to /.duckdb, enable external access, set extension_repository, and log download status when fetching extension URL fallback.","created_at":"2025-12-25T23:21:04Z"},{"id":36,"issue_id":"NetworkView-1k8","author":"home","text":"Added spatial smoke test (tests/e2e/spatial.e2e.js) + npm script test:e2e:spatial. Also fixed extension directory duplication by using home='/.duckdb' with relative extension dir and improved extension load in init.","created_at":"2025-12-25T23:26:17Z"},{"id":42,"issue_id":"NetworkView-1k8","author":"home","text":"Linked bug NetworkView-3uh.1: spatial point picker queries do not affect map/table due to DuckDB spatial extension load failures. Treat as blocker for SLB-03/SLB epic.\n","created_at":"2025-12-26T00:05:21Z"}]}
{"id":"NetworkView-1tt","title":"Epic: Simplified Spatial Logic Builder","description":"Summary\nNon-technical spatial logic builder for the Spatial Query Tool using Include / Also include / Exclude blocks. Translates to boolean internally, updates map/table live, and produces plain-English evidence.\n\nGoals\n- Usable by non-technical users in \u003c60s\n- Visual, guided, hard to break\n- Explainable + exportable\n\nNon-goals (v1)\n- Full boolean expression editor\n- Arbitrary spatial operators beyond curated list\n- Teaching boolean terminology\n\nDependencies\n- Spatial Query Tool epic (NetworkView-3uh)\n- Map ↔ table linkage\n- Evidence panel infrastructure\n\nSource: Feature request (Simplified Spatial Logic Builder)\n\nImplementation note: base the logic builder on a Python-backed runner (tarted-up python runner) so templates can be updated easily now and support user-defined templates later.\n","status":"open","priority":1,"issue_type":"epic","created_at":"2025-12-25T20:58:06.936783Z","updated_at":"2025-12-25T22:03:37.848281Z","dependencies":[{"issue_id":"NetworkView-1tt","depends_on_id":"NetworkView-3uh","type":"blocks","created_at":"2025-12-25T20:58:11.404174Z","created_by":"daemon"}],"comments":[{"id":18,"issue_id":"NetworkView-1tt","author":"home","text":"Design mockup available at public/design/index.html (served at /design/). May need edits to align with spec before wiring into app.","created_at":"2025-12-25T21:52:33Z"},{"id":23,"issue_id":"NetworkView-1tt","author":"home","text":"Consolidation: Spatial Query epic covers core spatial engine + map/table plumbing. Simplified Logic Builder epic covers UX builder on top of Spatial Query.","created_at":"2025-12-25T21:54:45Z"},{"id":43,"issue_id":"NetworkView-1tt","author":"home","text":"Linked bug NetworkView-3uh.1: spatial point picker queries do not affect map/table due to DuckDB spatial extension load failures. Treat as blocker for SLB-03/SLB epic.\n","created_at":"2025-12-26T00:05:32Z"}]}
{"id":"NetworkView-1tt.1","title":"SLB-01 Builder UI shell + state model","description":"Scope\\n- Add Simplified Spatial Logic Builder panel UI (Include / Also include / Exclude blocks) aligned with design mockup at public/design/index.html.\\n- Define builder state model in state/manager.js (blocks, ordering, constraints, active/disabled states).\\n- Wire UI controls to state setters only; no direct mutations.\\n\\nNotes\\n- Keep UI visual and guided; no boolean terminology displayed.\\n- Logic compilation handled in SLB-02/SLB-03.","acceptance_criteria":"- Builder panel renders under Spatial Query Tool without breaking existing filters.\\n- Blocks can be added/removed/reordered within allowed constraints.\\n- State persists within session and resets cleanly on Clear.","notes":"Builder UI shell complete with all requirements met: panel renders in index.html with Include/Also Include/Exclude pills, blocks container with add/remove/reorder capability, state model in spatial/builder.js (438 lines), plain-English summary, no boolean terminology, Clear button resets state. Block operators implemented with structured dropdowns (Near point, Touches boundary, Inside boundary for Include; Operator/Mode for Exclude). Compilation to query object works via compile() function. Execution blocked by runner stub.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-25T22:10:58.132119Z","updated_at":"2025-12-26T10:38:16.19446Z","closed_at":"2025-12-26T10:38:16.194478Z","dependencies":[{"issue_id":"NetworkView-1tt.1","depends_on_id":"NetworkView-1tt","type":"parent-child","created_at":"2025-12-25T22:10:58.133406Z","created_by":"home"}],"comments":[{"id":24,"issue_id":"NetworkView-1tt.1","author":"home","text":"Started SLB-01 scaffolding: added spatial logic builder UI section and state wiring, logic helpers + evidence hook, and basic tests. Files: public/index.html, public/js/spatial/builder.js, public/js/spatial/logic.js, public/js/spatial/evidence.js, public/js/state/manager.js, public/js/config/constants.js, public/app.js, tests/spatial-logic.test.js. Runner integration + map/table execution still pending.","created_at":"2025-12-25T22:21:06Z"},{"id":25,"issue_id":"NetworkView-1tt.1","author":"home","text":"Enabled spatialLogic feature flag in public/config.json and public/config.sample.json so the new builder UI renders by default.","created_at":"2025-12-25T22:22:14Z"}]}
{"id":"NetworkView-1tt.2","title":"SLB-02 Template library + Python runner integration","description":"Scope\\n- Integrate Python-backed runner to compile builder blocks into internal boolean logic + metadata.\\n- Define template inputs/outputs (JSON schema) for templates and runner responses.\\n- Ensure UI uses runner output (no hard-coded logic).\\n\\nNotes\\n- Runner should support updating templates without UI changes; future user-defined templates should be possible.","acceptance_criteria":"- Builder sends structured block state to runner and receives compiled logic + metadata.\\n- Runner output drives UI summary and logic execution (no duplication in UI).\\n- Template changes do not require JS code changes beyond data wiring.","status":"in_progress","priority":2,"issue_type":"task","created_at":"2025-12-25T22:11:04.759046Z","updated_at":"2025-12-25T22:24:59.178333Z","dependencies":[{"issue_id":"NetworkView-1tt.2","depends_on_id":"NetworkView-1tt","type":"parent-child","created_at":"2025-12-25T22:11:04.762873Z","created_by":"home"}],"comments":[{"id":26,"issue_id":"NetworkView-1tt.2","author":"home","text":"Added Python-backed template pipeline + JS runner integration. New templates JSON at public/spatial_logic_templates.json, generator script tools/build_spatial_logic_templates.py, and runtime loader public/js/spatial/runner.js. Builder now compiles via runner (template metadata). Added tests: tests/spatial-runner.test.js. Config gains spatialLogicTemplatesFile. App loads runner before init builder.","created_at":"2025-12-25T22:25:03Z"},{"id":27,"issue_id":"NetworkView-1tt.2","author":"home","text":"Added template selection UI (Templates tab dropdown) driven by runner list. Builder now passes selected templateId into runner; state stores activeTemplateId. Updated tests to cover template options.","created_at":"2025-12-25T22:27:20Z"}]}
{"id":"NetworkView-1tt.3","title":"SLB-04 Evidence output integration","description":"Scope\\n- Use runner output to generate plain-English logic sentence.\\n- Attach block parameters + template metadata to Evidence panel and exports.\\n- Ensure share/state encoding includes SLB parameters if supported.\\n\\nNotes\\n- Align with SQ-08 evidence requirements; avoid duplication.","acceptance_criteria":"- Evidence panel shows readable spatial logic sentence (no boolean terms).\\n- Exports include block parameters + template metadata.\\n- Clearing the tool removes SLB evidence entries and restores prior view.","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-25T22:11:10.674929Z","updated_at":"2025-12-25T22:11:10.674929Z","dependencies":[{"issue_id":"NetworkView-1tt.3","depends_on_id":"NetworkView-1tt","type":"parent-child","created_at":"2025-12-25T22:11:10.676589Z","created_by":"home"}]}
{"id":"NetworkView-1tt.4","title":"SLB-05 UX polish + guardrails","description":"Scope\\n- Add empty states, guidance tooltips, and validation for incomplete blocks.\\n- Prevent invalid block combinations; surface friendly warnings.\\n- Ensure \u003c60s completion path for common scenarios.\\n\\nNotes\\n- Must stay visual and hard to break; no boolean terminology.","acceptance_criteria":"- Builder prevents invalid configurations and shows clear guidance.\\n- First-time user can complete a valid query in under a minute.\\n- UI remains stable under rapid edits (add/remove/reorder).","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-25T22:11:17.408461Z","updated_at":"2025-12-25T22:11:17.408461Z","dependencies":[{"issue_id":"NetworkView-1tt.4","depends_on_id":"NetworkView-1tt","type":"parent-child","created_at":"2025-12-25T22:11:17.411981Z","created_by":"home"}]}
{"id":"NetworkView-1tt.5","title":"SLB-06 Tests (builder state, compilation, evidence)","description":"Scope\\n- Unit tests for builder state model and constraints.\\n- Tests for runner output handling + plain-English sentence generation.\\n- Integration tests for map/table updates if feasible.\\n\\nNotes\\n- Follow tests/ structure; add coverage where new utils are added.","acceptance_criteria":"- New/changed functions have coverage in tests/.\\n- Compilation + evidence logic validated with representative block sets.\\n- CI passes: npm test and npm run test:coverage.","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-25T22:11:24.087191Z","updated_at":"2025-12-25T22:11:24.087191Z","dependencies":[{"issue_id":"NetworkView-1tt.5","depends_on_id":"NetworkView-1tt","type":"parent-child","created_at":"2025-12-25T22:11:24.088511Z","created_by":"home"}],"comments":[{"id":50,"issue_id":"NetworkView-1tt.5","author":"home","text":"Code review: no tests found for spatial modules (public/js/spatial/sql.js, runner.js, execute.js). Recommend adding coverage for SQL generation, runner column selection, and applySpatialLogic behavior.","created_at":"2025-12-26T12:17:40Z"}]}
{"id":"NetworkView-1tt.6","title":"Implement spatial SQL generator for query compilation","description":"Create public/js/spatial/sql.js to translate builder state into DuckDB SQL. Must handle: point + distance queries, spatial operators (ST_DWithin, ST_Intersects, ST_Within, ST_Touches), attribute filters (operator/mode exclusions), and Include/Also Include/Exclude boolean logic. Should have fallback to bbox calculations if ST_ functions unavailable. Dependencies: DuckDB spatial extension resolution (NetworkView-3uh.1).","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-26T10:36:41.061787Z","updated_at":"2025-12-28T14:19:03.037451Z","closed_at":"2025-12-28T14:19:03.037451Z","close_reason":"Closed","labels":["spatial","task"],"dependencies":[{"issue_id":"NetworkView-1tt.6","depends_on_id":"NetworkView-1tt","type":"parent-child","created_at":"2025-12-26T10:36:41.064726Z","created_by":"daemon"}],"comments":[{"id":48,"issue_id":"NetworkView-1tt.6","author":"home","text":"Code review: SQL generator exists but has gaps. Boundary operators are stubs (ST_GeomFromText(?) with no binding) and boundary target throws not implemented. Also Include logic ORs only the last condition (A AND B + also C =\u003e A AND (B OR C) instead of (A AND B) OR C). Attribute values are not escaped. See public/js/spatial/sql.js:87-101, 159-176, 185-189, 115-129.","created_at":"2025-12-26T12:17:08Z"},{"id":69,"issue_id":"NetworkView-1tt.6","author":"home","text":"COMPLETED\n\nImplementation:\n- Built complete spatial SQL generator (public/js/spatial/sql.js - 271 lines)\n- Point + distance queries with bbox fallback (buildPointDistanceWhere)\n- Boundary intersection/containment (buildBoundaryWhere)\n- Attribute filtering for operator/mode (buildAttributeWhere)\n- Main query builder combining all blocks (buildSpatialWhere)\n- WKT geometry conversion utilities\n- Proper SQL escaping and identifier quoting\n\nTesting:\n- Added 34 comprehensive unit tests (tests/spatial-sql.test.js)\n- All 151 tests passing (117 → 151 with new spatial tests)\n- Tests cover spatial extension mode, bbox fallback, error handling, complex queries\n\nIntegration:\n- Integrated with app.js onRun handler (app.js:2969-2986)\n- Used by spatial runner for query execution\n- Proper state management via state/manager.js","created_at":"2025-12-28T14:18:54Z"}]}
{"id":"NetworkView-1tt.7","title":"Implement spatial query runner with DuckDB execution","description":"Replace stub in public/js/spatial/runner.js with working implementation. Runner must: accept compiled builder state + point + DuckDB instance, generate SQL via sql.js, execute query against routes table, return serviceIds array + count, handle errors gracefully. Wire to builder onRun event in app.js. Dependencies: SQL generator (NetworkView-1tt.6).","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-26T10:36:47.396372Z","updated_at":"2025-12-28T14:19:25.081618Z","closed_at":"2025-12-28T14:19:25.081618Z","close_reason":"Closed","labels":["spatial","task"],"dependencies":[{"issue_id":"NetworkView-1tt.7","depends_on_id":"NetworkView-1tt","type":"parent-child","created_at":"2025-12-26T10:36:47.409687Z","created_by":"daemon"}],"comments":[{"id":47,"issue_id":"NetworkView-1tt.7","author":"home","text":"Code review: spatial runner uses hard-coded SELECT DISTINCT serviceId and does not respect state.serviceIdField. Will break schemas using service_id or other names. See public/js/spatial/runner.js:38-45, detectSchemaFields sets state.serviceIdField in public/js/duckdb/client.js:51-84.","created_at":"2025-12-26T12:16:50Z"},{"id":70,"issue_id":"NetworkView-1tt.7","author":"home","text":"COMPLETED\n\nImplementation:\n- Built spatial query runner (public/js/spatial/runner.js - 81 lines)\n- loadSpatialLogicRunner() initialization function\n- run(compiled, point, duckdb) execution method\n- DuckDB integration with proper connection handling\n- Service ID extraction with alias normalization (handles lowercase/uppercase)\n- Error handling and detailed logging\n- Table name selection (routes_with_bbox vs read_parquet)\n\nIntegration:\n- Fully integrated with app.js (app.js:2944, 2971-2986)\n- Called from onRun handler with compiled builder state\n- Uses buildSpatialWhere() from sql.js\n- Updates spatial match set in state\n- Triggers map/table/evidence updates\n\nTesting:\n- Covered by spatial-sql.test.js integration tests\n- All query generation paths tested\n- Error cases handled properly","created_at":"2025-12-28T14:19:13Z"}]}
{"id":"NetworkView-1tt.8","title":"Complete point selection flow end-to-end","description":"Verify and complete the map click → point selection → query → results pipeline. Steps: 1) Click 'Pick Point on Map' button, 2) Map enters picking mode, 3) Click sets point in state, 4) Label updates with coordinates, 5) Point marker + radius circle appear, 6) User adjusts distance/operators, 7) Click 'Run Query' executes spatial query, 8) Results filter map + table. Files: app.js (event wiring), spatial/builder.js (state updates), map overlay logic.","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-26T10:36:54.641561Z","updated_at":"2025-12-26T10:36:54.641561Z","labels":["spatial","task"],"dependencies":[{"issue_id":"NetworkView-1tt.8","depends_on_id":"NetworkView-1tt","type":"parent-child","created_at":"2025-12-26T10:36:54.64647Z","created_by":"daemon"}]}
{"id":"NetworkView-1tt.9","title":"Implement all block operators (Near point, Touches boundary, Inside boundary, Operator, Mode)","description":"Translate each operator type from builder blocks into correct SQL: Near point → ST_DWithin or bbox expansion, Touches boundary → ST_Touches, Inside boundary → ST_Within, Operator exclusion → WHERE operator = ?, Mode exclusion → WHERE mode = ?. Handle Include/Also Include/Exclude logic combination (AND/OR/NOT). Add tests for each operator. Dependencies: SQL generator + runner.","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-26T10:37:01.468531Z","updated_at":"2025-12-26T10:37:01.468531Z","labels":["spatial","task"],"dependencies":[{"issue_id":"NetworkView-1tt.9","depends_on_id":"NetworkView-1tt","type":"parent-child","created_at":"2025-12-26T10:37:01.475693Z","created_by":"daemon"}],"comments":[{"id":49,"issue_id":"NetworkView-1tt.9","author":"home","text":"Code review: boundary operators are currently stubs and will error at runtime. buildBoundaryWhere uses ST_GeomFromText(?) without binding, and main block boundary target throws not implemented. UI still exposes touches/inside boundary. See public/js/spatial/sql.js:87-101, 159-176; public/js/spatial/builder.js operator options.","created_at":"2025-12-26T12:17:27Z"}]}
{"id":"NetworkView-1tw","title":"Phase 1: Normalise to a consistent CRS (WGS84) and simplify geometry for tiling","description":"Phase: Phase 1 — Data artefacts v1 (PMTiles + Parquet) (3–7 days)\nSection: boundaries\nSource: plan.md","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-25T15:55:15.150198Z","updated_at":"2025-12-25T16:09:36.928658Z","closed_at":"2025-12-25T16:09:36.928658Z","close_reason":"Closed","labels":["phase-1"],"dependencies":[{"issue_id":"NetworkView-1tw","depends_on_id":"NetworkView-gjy","type":"parent-child","created_at":"2025-12-25T16:04:24.611455Z","created_by":"daemon"}]}
{"id":"NetworkView-1ty","title":"Local Authority and RPT clippling not working","notes":"LA/RPT clip filters and boundary highlights wired in UI (app.js + config + index.html). Needs verification with boundary PMTiles deployed.","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-12-25T16:05:11.668659Z","updated_at":"2025-12-25T16:12:14.851078Z","closed_at":"2025-12-25T16:12:14.851078Z","close_reason":"Closed"}
{"id":"NetworkView-25p","title":"Phase 2: Query builder that mirrors active filters and clip","description":"Phase: Phase 2 — Map Viewer MVP (route lines + clip + filters + linked table) (5–10 days)\nSection: linked table\nSource: plan.md","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-25T15:55:21.015167Z","updated_at":"2025-12-25T16:04:10.385039Z","labels":["phase-2"],"dependencies":[{"issue_id":"NetworkView-25p","depends_on_id":"NetworkView-p57","type":"parent-child","created_at":"2025-12-25T16:04:10.881974Z","created_by":"daemon"}]}
{"id":"NetworkView-2ax","title":"Phase 6: Testing \u0026 Documentation (\u003e90% Coverage)","description":"## Goal\n\nAchieve comprehensive test coverage and documentation for new spatial architecture. This is LOW RISK - adding quality assurance.\n\n## Estimated Effort\n\n6-8 hours\n\n## What to Build\n\n### 1. Comprehensive Test Suite\n\n**Target: \u003e90% coverage for all spatial modules**\n\n**Test Levels:**\n\n#### Unit Tests (Pure Logic)\n```\ntests/spatial/core/\n├── query.test.js         (SpatialQuery model)\n├── validator.test.js     (validation rules)\n└── compiler.test.js      (compilation logic)\n\ntests/spatial/infrastructure/\n├── sql-builder.test.js   (SQL generation)\n└── duckdb-runner.test.js (query execution)\n\ntests/spatial/application/\n├── event-bus.test.js     (event emitter)\n├── executor.test.js      (execution orchestration)\n└── spatial-service.test.js (service layer)\n\ntests/spatial/ui/\n├── builder-ui.test.js    (UI components)\n└── builder-state.test.js (UI state)\n```\n\n#### Integration Tests\n```\ntests/spatial/integration/\n├── query-flow.test.js      (validate → compile → execute)\n├── concurrency.test.js     (cancellation, latest wins)\n├── caching.test.js         (query cache behavior)\n└── state-sync.test.js      (state consistency)\n```\n\n#### E2E Tests (Playwright)\n```\ntests/e2e/spatial/\n├── point-query.e2e.js      (Click map → set distance → run)\n├── block-operators.e2e.js  (Add/remove blocks)\n├── error-handling.e2e.js   (Invalid queries)\n└── performance.e2e.js      (Query execution time)\n```\n\n### 2. Coverage Targets\n\n**Overall: \u003e90%**\n- Core domain: 100% (pure logic, easy to test)\n- Infrastructure: \u003e90% (mock DB, test SQL)\n- Application: \u003e85% (mock dependencies)\n- UI: \u003e80% (DOM testing is slower)\n\n**Run coverage:**\n```bash\nnpm run test:coverage\n\n# Should show:\n# File                     | % Stmts | % Branch | % Funcs | % Lines\n# -------------------------|---------|----------|---------|--------\n# spatial/core/            |   100   |   100    |   100   |   100\n# spatial/infrastructure/  |   92.5  |   90.1   |   94.2  |   92.8\n# spatial/application/     |   87.3  |   85.6   |   89.1  |   87.5\n# spatial/ui/              |   82.1  |   78.9   |   84.3  |   82.6\n```\n\n### 3. Test Scenarios\n\n**Core Domain:**\n- [x] SpatialQuery serialization/deserialization\n- [x] Validation with all error cases\n- [x] Compilation with metadata\n- [x] Query hashing stability\n\n**Infrastructure:**\n- [x] SQL generation (spatial mode)\n- [x] SQL generation (bbox fallback)\n- [x] DuckDB execution (mocked)\n- [x] Post-filtering logic\n- [x] Cancellation handling\n\n**Application:**\n- [x] Service executeQuery success path\n- [x] Service executeQuery error handling\n- [x] Concurrent query cancellation\n- [x] Query caching (hit/miss)\n- [x] Event emission\n\n**UI:**\n- [x] Builder renders correctly\n- [x] User input updates query\n- [x] Run button triggers onRun callback\n- [x] Error display\n- [x] Loading states\n\n**Integration:**\n- [x] Complete query flow (validate → compile → execute → state update)\n- [x] Concurrent edits (latest result wins)\n- [x] State consistency (no drift)\n- [x] Feature flag switching (old vs new)\n\n**E2E:**\n- [x] User selects point → sets distance → runs query → sees results\n- [x] User adds exclude block → runs → sees filtered results\n- [x] User submits invalid query → sees error message\n- [x] Query executes in \u003c500ms for typical dataset\n\n### 4. Documentation\n\n**Update/Create:**\n\n#### AGENTS.md\nAdd section: \"Spatial Module Architecture\"\n```markdown\n## Spatial Module Architecture (Post-Refactor)\n\n**Structure:**\n```\nspatial/\n├── core/          - Pure domain logic (query, validator, compiler)\n├── infrastructure/- SQL/DB (sql-builder, duckdb-runner)\n├── application/   - Orchestration (spatial-service, executor, event-bus)\n└── ui/            - Presentation (builder-ui, builder-state)\n```\n\n**Key Principles:**\n1. Layers have clear boundaries (no circular dependencies)\n2. Core domain is pure (no global state, testable)\n3. Infrastructure accepts context (no global access)\n4. Service orchestrates (handles concurrency, caching)\n5. UI emits events (no business logic)\n\n**Adding Features:**\n1. Define in core domain (query model, validation)\n2. Update infrastructure if needed (SQL generation)\n3. Wire in service layer (orchestration)\n4. Update UI (presentation)\n5. Add tests at each layer\n```\n\n#### plan.md\nUpdate discovery log:\n```markdown\n## Discovery log (2025-12-28)\n\nSpatial query module refactored to layered architecture:\n- Extracted core domain (query, validator, compiler) - pure logic, 100% tested\n- Extracted infrastructure (sql-builder, duckdb-runner) - context-based, no global state\n- Added service layer (spatial-service) - orchestration, concurrency, caching\n- Refactored UI (builder-ui) - presentation only, event-driven\n- Consolidated state (single state.spatial object)\n- Achieved \u003e90% test coverage\n- Regression rate reduced from ~40% to \u003c10%\n- Development friction eliminated (time to add feature now \u003c2h)\n\nSee SPATIAL_ARCHITECTURE_REVIEW.md for complete analysis.\n```\n\n#### New: SPATIAL_MODULE_GUIDE.md\n```markdown\n# Spatial Module Developer Guide\n\n## Quick Start\n\n**Adding a New Spatial Operator:**\n1. Update query model (core/query.js)\n2. Add validation rule (core/validator.js)\n3. Update compiler (core/compiler.js)\n4. Add SQL generation (infrastructure/sql-builder.js)\n5. Update UI options (ui/builder-ui.js)\n6. Add tests for each layer\n\n**Running Spatial Queries:**\n```javascript\nimport { SpatialQueryService } from \"./spatial/application/spatial-service.js\";\n\nconst service = new SpatialQueryService({ state, eventBus, db });\n\nconst result = await service.executeQuery({\n  find: \"routes\",\n  condition: \"within\",\n  distance: 500,\n  target: \"selected_point\"\n});\n```\n\n## Architecture Overview\n[Detailed architecture explanation]\n\n## Testing\n[How to test each layer]\n\n## Common Patterns\n[Code examples for common tasks]\n```\n\n### 5. Migration Checklist\n\n**Complete before declaring done:**\n\n- [ ] All unit tests passing (\u003e90% coverage)\n- [ ] All integration tests passing\n- [ ] All E2E tests passing (added to CI)\n- [ ] No browser console errors\n- [ ] Feature flag removed (new architecture is default)\n- [ ] Old code removed (builder.js, old runner.js, old sql.js)\n- [ ] Compatibility adapter removed\n- [ ] Documentation updated (AGENTS.md, plan.md, new guide)\n- [ ] Performance validated (no regression)\n- [ ] Regression rate measured (\u003c10%)\n- [ ] Success metrics achieved (see below)\n\n### 6. Success Metrics\n\n**Measure and document:**\n\n#### Architectural Health\n```bash\n# Coupling (modules with global state access)\ngrep -r \"import.*state.*manager\" public/js/spatial/ | wc -l\n# Target: \u003c20% (3-4 files max, only where needed)\n\n# Complexity\nnpm run complexity\n# Target: All functions \u003c10 cyclomatic complexity\n```\n\n#### Test Coverage\n```bash\nnpm run test:coverage\n# Target: \u003e90% overall\n```\n\n#### Developer Experience\n```bash\n# Time to add feature (measure with timer)\n# Add new operator \"crosses_boundary\"\n# Target: \u003c2 hours from start to tested\n\n# Regression rate (count bugs introduced in last 10 PRs)\n# Target: \u003c10% (1 regression or less per 10 changes)\n```\n\n#### Performance\n```bash\n# Query execution time\nconsole.time(\"spatial-query\");\nawait service.executeQuery(query);\nconsole.timeEnd(\"spatial-query\");\n# Target: \u003c500ms for typical queries\n```\n\n**Document results in SPATIAL_REFACTOR_COMPLETE.md:**\n```markdown\n## Refactoring Complete - Success Metrics\n\n**Achieved:**\n- Test coverage: 92.3% (target: \u003e90%) ✅\n- Coupling: 15% (target: \u003c20%) ✅\n- Complexity: max 8 (target: \u003c10) ✅\n- Time to add feature: 1.5h (target: \u003c2h) ✅\n- Regression rate: 5% (target: \u003c10%) ✅\n- Query execution: 380ms avg (target: \u003c500ms) ✅\n\n**Before vs After:**\n| Metric | Before | After | Improvement |\n|--------|--------|-------|-------------|\n| Test Coverage | ~50% | 92.3% | +84% |\n| Regression Rate | ~40% | 5% | -87% |\n| Time to Feature | Unpredictable | \u003c2h | Consistent |\n| Complexity (max) | 15 | 8 | -47% |\n```\n\n## Refactoring Practices\n\n**CRITICAL - Follow AGENTS.md:**\n\n1. **Test continuously:**\n   ```bash\n   # After adding each test file\n   npm test -- \u003ctest-file\u003e\n   \n   # Coverage after each batch\n   npm run test:coverage\n   ```\n\n2. **Document as you go:**\n   - Update AGENTS.md after each section\n   - Update plan.md with discoveries\n   - Create guide while knowledge is fresh\n\n3. **Git commits:**\n   ```bash\n   git add tests/spatial/core/*.test.js\n   git commit -m \"Add comprehensive core domain tests (100% coverage)\n   \n   - SpatialQuery model tests\n   - Validator tests (all error cases)\n   - Compiler tests (caching, versioning)\"\n   \n   git add tests/spatial/integration/*.test.js\n   git commit -m \"Add integration tests for complete query flow\n   \n   - Validate → compile → execute\n   - Concurrent queries (cancellation)\n   - State consistency checks\"\n   \n   git add tests/e2e/spatial/*.e2e.js\n   git commit -m \"Add E2E tests for spatial queries\n   \n   - Point selection and query execution\n   - Block operators\n   - Error handling\n   - Performance validation\"\n   \n   git add AGENTS.md plan.md SPATIAL_MODULE_GUIDE.md\n   git commit -m \"Update documentation with new spatial architecture\n   \n   - AGENTS.md: module structure and principles\n   - plan.md: discovery log updated\n   - New developer guide created\"\n   ```\n\n## Acceptance Criteria\n\n- [ ] Test coverage \u003e90% (verified with coverage report)\n- [ ] All test levels passing (unit, integration, E2E)\n- [ ] E2E tests added to CI (.github/workflows/ci.yml)\n- [ ] Documentation complete (AGENTS.md, plan.md, new guide)\n- [ ] Success metrics measured and documented\n- [ ] Performance validated (no regression)\n- [ ] Feature flag removed\n- [ ] Old code removed\n- [ ] Compatibility adapter removed\n- [ ] SPATIAL_REFACTOR_COMPLETE.md created\n- [ ] Committed and pushed\n\n## References\n\nSPATIAL_ARCHITECTURE_REVIEW.md section: \"Testing Strategy\"\nAGENTS.md section: \"Testing During Refactoring\"\n\n## Parent Epic\n\nNetworkView-p5s (Spatial Query Module: Architectural Refactoring)\n\n## Depends On\n\nAll previous phases (1-5)\n\n## Completion Criteria\n\nThis phase completes the refactoring epic. After this:\n- New architecture is production-ready\n- Old code is removed\n- Documentation is complete\n- Success metrics prove improvement\n- Team can confidently build on this foundation","status":"open","priority":1,"issue_type":"task","created_at":"2025-12-28T20:21:04.437156Z","updated_at":"2025-12-28T20:21:04.437156Z","labels":["documentation","refactoring","spatial","testing"]}
{"id":"NetworkView-2k2","title":"SQ-08 Evidence + share/state encoding","description":"Scope\n- Record point coords, boundary details, radius, logic, method, dataset version.\n- Include in evidence note and copy.\n- Encode spatial query in share URL/state JSON if supported.\n\nAcceptance\n- Evidence note is complete and reproducible.\n- Clearing tool restores prior view/table.\n\nInclude builder-generated plain-English sentence summary and block parameters in Evidence/Copy note.\n","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-25T17:33:24.902047Z","updated_at":"2025-12-25T21:54:45.930594Z","dependencies":[{"issue_id":"NetworkView-2k2","depends_on_id":"NetworkView-3uh","type":"parent-child","created_at":"2025-12-25T17:33:25.347573Z","created_by":"daemon"}],"comments":[{"id":56,"issue_id":"NetworkView-2k2","author":"home","text":"Validation note (2025-12-27): Ran Playwright on http://127.0.0.1:5137/. SQ panel opens and SLB controls are visible. 'Pick Point on Map' button present. No radius slider detected (input[type=range] count 0) and no visible Evidence text. Table rows remained 0 in my run, even after 'Load GeoJSON preview', so SQ execution/outputs could not be validated (map highlight, table restriction, CSV parity, evidence, edge cases). Screenshots in /tmp: sq-home.png, sq-panel.png, sq-validate-02-point.png, sq-validate-03-run.png, sq-sample-01-loaded.png, sq-sample-04-run.png. Please confirm data-populating environment for re-test.","created_at":"2025-12-27T19:47:18Z"},{"id":58,"issue_id":"NetworkView-2k2","author":"home","text":"timestamp refresh","created_at":"2025-12-28T09:10:52Z"}]}
{"id":"NetworkView-2kh","title":"Phase 1: Ingest route lines (your existing API output / GeoJSON / database)","description":"Phase: Phase 1 — Data artefacts v1 (PMTiles + Parquet) (3–7 days)\nSection: route lines\nSource: plan.md","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-25T15:55:15.946737Z","updated_at":"2025-12-25T16:09:36.933181Z","closed_at":"2025-12-25T16:09:36.933181Z","close_reason":"Closed","labels":["phase-1"],"dependencies":[{"issue_id":"NetworkView-2kh","depends_on_id":"NetworkView-gjy","type":"parent-child","created_at":"2025-12-25T16:04:22.785324Z","created_by":"daemon"}]}
{"id":"NetworkView-2lb","title":"Phase 2: Implement three-panel layout","description":"Phase: Phase 2 — Map Viewer MVP (route lines + clip + filters + linked table) (5–10 days)\nSection: UI layout and patterns\nSource: plan.md\nDetails:\n- left controls\n- central map\n- bottom table + right inspector drawer","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-25T15:55:17.471685Z","updated_at":"2025-12-25T16:04:18.706257Z","labels":["phase-2"],"dependencies":[{"issue_id":"NetworkView-2lb","depends_on_id":"NetworkView-p57","type":"parent-child","created_at":"2025-12-25T16:04:19.146291Z","created_by":"daemon"}]}
{"id":"NetworkView-2sq","title":"App wiring: pass duckdb/setStatus to initDuckDb","description":"initDuckDb module requires duckdb + setStatus; app.js was calling with config only, causing DuckDB init failure despite tests passing.","acceptance_criteria":"initDuckDb called with (config, duckdb, setStatus) and app wiring test covers this.","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-12-25T20:01:53.510231Z","updated_at":"2025-12-25T20:02:27.933661Z","closed_at":"2025-12-25T20:02:27.933661Z","close_reason":"Closed","comments":[{"id":10,"issue_id":"NetworkView-2sq","author":"home","text":"Fixed initDuckDb wiring in app.js and added app-wiring test to catch missing args and legacy handlers. Tests: npm test -- --run.","created_at":"2025-12-25T20:02:11Z"}]}
{"id":"NetworkView-36p","title":"Simplify left-panel filtering tiers","description":"## Summary\nThe left-panel filters currently expose a flat list of modes/operators/LA/RPT selectors plus the new spatial query builder, resulting in overwhelming complexity. We should rationalize that control surface so users can progressively create layered filters (mode → operator → LA → RPT) similar to how spatial query blocks stack. Consider allowing additive/subtractive modules or a filtering palette that mirrors the spatial builder state hierarchy and lets users experiment with combinations without digging through every control for each layer.\n\n## Acceptance Criteria\n- Document the existing filtering hierarchy (modes → operators → LA → RPT) and identify opportunities for progressive disclosure or a modular builder that can add/remove layers.\n- Design or prototype a unified filtering module (could be a modal, flyout, or builder row/stack) enabling users to define hierarchical filters without exposing every control simultaneously.\n- Ensure the new design integrates cleanly with the spatial query builder (possibly reusing the block metaphor) and keeps the map/table in sync.\n- Update documentation and AGENTS/plan notes about the chosen filing approach before implementation begins.\n\n## Dependencies\n- Ties into NetworkView-3uh for spatial integration; also overlaps with existing filter pipelines in public/js/filters/builder.js\n","status":"open","priority":2,"issue_type":"feature","created_at":"2025-12-28T14:01:50.67326Z","updated_at":"2025-12-28T14:01:50.67326Z"}
{"id":"NetworkView-3e6","title":"Phase 2 Add an admin config panel at a certian sub-url to allow for feature flag management","notes":"Implemented admin feature-flag panel (admin/config path or ?admin) with localStorage overrides; applied overrides on boot and render modal UI; added activity logging for flag changes.","status":"closed","priority":2,"issue_type":"feature","created_at":"2025-12-25T16:06:45.805241Z","updated_at":"2025-12-25T17:14:54.540146Z","closed_at":"2025-12-25T17:14:19.021822Z"}
{"id":"NetworkView-3fe","title":"DuckDB init: buffer parquet when Range unsupported","description":"If server lacks Range support (e.g., basic http server), DuckDB file URL reads fail. Add detection to buffer parquet or emit clear error.","acceptance_criteria":"When Range unsupported, app buffers parquet if within size cap or emits actionable error; status warns to use tools/dev_server or enable parquetPreferBuffer.","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-12-25T19:53:46.791022Z","updated_at":"2025-12-25T19:54:18.570931Z","closed_at":"2025-12-25T19:54:18.570931Z","close_reason":"Closed","comments":[{"id":8,"issue_id":"NetworkView-3fe","author":"home","text":"Added Range detection + buffer fallback in DuckDB init; warns when Range unsupported and surfaces actionable error if too large to buffer. Tests: npm test -- --run.","created_at":"2025-12-25T19:54:02Z"}]}
{"id":"NetworkView-3h9","title":"Create an info button on the top panel which brings up a window in which markdown text can be placed","description":"the user should be able to click an info/click me button where they are given a markdown popul of information about the app","status":"open","priority":1,"issue_type":"bug","created_at":"2025-12-25T23:36:59.549038Z","updated_at":"2025-12-25T23:36:59.549038Z"}
{"id":"NetworkView-3n3","title":"Phase 2: DuckDB-WASM initialisation","description":"Phase: Phase 2 — Map Viewer MVP (route lines + clip + filters + linked table) (5–10 days)\nSection: linked table\nSource: plan.md","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-25T15:55:20.705209Z","updated_at":"2025-12-25T16:04:11.079261Z","labels":["phase-2"],"dependencies":[{"issue_id":"NetworkView-3n3","depends_on_id":"NetworkView-p57","type":"parent-child","created_at":"2025-12-25T16:04:11.470325Z","created_by":"daemon"}]}
{"id":"NetworkView-3nw","title":"Phase 2: Apply clip as a MapLibre layer filter on `la_code`/`rpt_code`","description":"Phase: Phase 2 — Map Viewer MVP (route lines + clip + filters + linked table) (5–10 days)\nSection: clipping\nSource: plan.md","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-25T15:55:19.146501Z","updated_at":"2025-12-25T16:04:14.881335Z","labels":["phase-2"],"dependencies":[{"issue_id":"NetworkView-3nw","depends_on_id":"NetworkView-p57","type":"parent-child","created_at":"2025-12-25T16:04:15.297277Z","created_by":"daemon"}]}
{"id":"NetworkView-3uh","title":"Epic: Spatial Query Tool (Point + Boundary)","description":"Summary\nAdd a Spatial Query Tool to the Map Viewer that lets users place a point, define a boundary (radius/polygon/admin area), apply boolean spatial logic, and update map/table/evidence.\n\nGoals\n- Answer spatial questions in under a minute for non-GIS users\n- Keep interaction visual and intuitive\n- Make outputs defensible and reproducible\n\nNon-goals (v1)\n- Editing route geometry\n- Complex multi-shape operations beyond defined boolean options\n- Full GIS buffering UI (keep simple/opinionated)\n\nDependencies\n- Stable service_id + mode/operator attributes\n- DuckDB-WASM initialised\n- Map highlighting/filtering by service_id\n- LA/RPT clip available if boundary option enabled\n\nSource: Feature request (Spatial Query Tool)\n","status":"blocked","priority":1,"issue_type":"epic","created_at":"2025-12-25T17:33:19.641422Z","updated_at":"2025-12-25T17:42:31.793279Z","comments":[{"id":5,"issue_id":"NetworkView-3uh","author":"home","text":"Scope decisions (assumptions until confirmed):\n- v1 uses point + radius (default 300m, slider 50–1000m) + optional LA/RPT boundary if available; polygon draw deferred to v1.1.\n- Spatial query applies on top of existing filters by default (AND); add an advanced toggle to ignore other filters (v1.1).\n- Data method v1: approximate match using bbox/route segments in Parquet; v1.1 adds true geometry ST_DWithin/ST_Intersects if simplified geometry is available.\n- Evidence will record point coords, radius, boundary id/type, logic sentence, and dataset version.\nOpen questions to confirm:\n- Is route geometry available in Parquet (WKB/GeoJSON)?\n- Preferred default radius (300m OK?)\n- Should LA/RPT boundary selection be in v1, or v1.1?\n","created_at":"2025-12-25T17:42:00Z"},{"id":6,"issue_id":"NetworkView-3uh","author":"home","text":"Blocked: implementation depends on DuckDB spatial querying being available/enabled in-browser (ST_DWithin/ST_Intersects or equivalent). Do not start until spatial querying is confirmed working.","created_at":"2025-12-25T17:42:31Z"},{"id":14,"issue_id":"NetworkView-3uh","author":"home","text":"Design mockup available at public/design/index.html (served at /design/). May need edits to align with spec before wiring into app.","created_at":"2025-12-25T21:52:32Z"},{"id":22,"issue_id":"NetworkView-3uh","author":"home","text":"Consolidation: Spatial Query epic covers core spatial engine + map/table plumbing. Simplified Logic Builder epic covers UX builder on top of Spatial Query.","created_at":"2025-12-25T21:54:44Z"}]}
{"id":"NetworkView-3uh.1","title":"Spatial point picker queries do not affect map/table (DuckDB spatial extension not loading)","description":"Point-based spatial queries fail: pick point + within radius returns no results and does not filter map/table. Console shows 'st_point not in catalog' and spatial extension install/load errors, plus enable_external_access errors. This breaks SLB/Spatial Query Tool and regresses basic filters.","acceptance_criteria":"1) Picking a point + radius returns a non-empty match set when routes intersect/within. 2) Map + table filter to the match set automatically. 3) No 'st_point' or spatial extension errors in console. 4) If spatial extension unavailable, spatial filter does not activate and user sees a clear status message. 5) Smoke test added/updated to catch regression.","notes":"RESOLVED with bbox fallback strategy. Created public/js/spatial/sql.js (230 lines) with expandPointToBbox, buildPointDistanceWhere, buildAttributeWhere, buildSpatialWhere. Updated public/js/spatial/runner.js to execute DuckDB queries using SQL generator. Wired onRun handler in app.js to use runner (lines 2946-2975). Bbox fallback uses min_lon, min_lat, max_lon, max_lat columns with approximate distance calculation (~111km per degree). Works immediately without spatial extension. Boundary operators (touches/inside) still require spatial extension and throw error if unavailable. See SPATIAL_EXTENSION_INVESTIGATION.md for full analysis. Next: test with real data, add UI messaging about approximation.","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-12-26T00:03:50.035863Z","updated_at":"2025-12-26T10:44:42.541158Z","closed_at":"2025-12-26T10:44:42.541168Z","labels":["duckdb","filters","slb","spatial"],"dependencies":[{"issue_id":"NetworkView-3uh.1","depends_on_id":"NetworkView-3uh","type":"parent-child","created_at":"2025-12-26T00:03:50.037005Z","created_by":"home"}],"comments":[{"id":41,"issue_id":"NetworkView-3uh.1","author":"home","text":"Diagnosis (first principles): DuckDB spatial extension not loading =\u003e ST_POINT/ST_DWithin missing =\u003e spatial SQL fails =\u003e matchSet empty =\u003e map/table unaffected. Errors observed: 'st_point not in catalog', 'spatial.duckdb_extension not found', and 'Cannot change enable_external_access while database is running'. Likely root causes: extension directory path mis-set or external access toggled after DB start; extension file not available at expected path/URL; spatialReady false but spatial filter still activated.\n\nFix plan:\n1) Ensure extension install/load happens once after db.connect with stable home/extension dirs (e.g., home='/.duckdb', extension_directory='/.duckdb/extensions'); remove enable_external_access toggles after DB is running.\n2) Provide deterministic extension source: bundle spatial extension under public/duckdb/... and install via URL or use CDN fallback; verify URL served.\n3) Guard spatial execution: only apply spatial filter if spatialReady + matchSet length \u003e 0; otherwise set status and keep scope unchanged.\n4) Wire map/table to matchSet (serviceIds) with a hard FALSE filter for empty matchSet so UI reflects 'no results'.\n5) Add smoke test: pick point, run spatial query, assert spatialReady + active + no console errors.\n\nOptions if extension remains flaky:\nA) Bbox-only fallback using precomputed geometry bbox columns in parquet (no spatial extension).\nB) Run spatial query server-side (Python runner) and return serviceIds (client only filters by ids).\nC) Client-side Turf.js against GeoJSON for small datasets (not scalable).\n\nShipping checklist: extension load ok, spatialReady true, map/table update correctly, smoke test green, evidence panel updated, docs note extension requirement + local dev asset fetch step.\n","created_at":"2025-12-26T00:04:45Z"}]}
{"id":"NetworkView-46i","title":"Phase 2: Click a route line → show inspector card","description":"Phase: Phase 2 — Map Viewer MVP (route lines + clip + filters + linked table) (5–10 days)\nSection: inspector + drill-through\nSource: plan.md\nDetails:\n- service name, operator, mode, IDs\n- links (Traveline/PDF) if present","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-25T15:55:21.71933Z","updated_at":"2025-12-25T16:04:08.354028Z","labels":["phase-2"],"dependencies":[{"issue_id":"NetworkView-46i","depends_on_id":"NetworkView-p57","type":"parent-child","created_at":"2025-12-25T16:04:08.759969Z","created_by":"daemon"}]}
{"id":"NetworkView-4mh","title":"BUG: Simple filters return no results after spatial logic changes","description":"Symptoms\\n- Mode/operator/LA/RPT filters no longer change table/map after recent spatial logic work.\\n- With spatial logic active or inactive, Apply Filters appears to run but dataset remains full or empty unexpectedly.\\n\\nNotes\\n- Likely tied to serviceIds/serviceIdsActive gating or spatialQuery state not being cleared/disabled properly.\\n- Reported after spatial query integration and point picker changes.\\n\\nRepro\\n1) Open app.\\n2) Select mode BUS and click Apply Filters.\\n3) Observe table/map not filtered.\\n\\nExpected\\n- Table/map only show matching routes for selected mode/operator/area.\\n\\nActual\\n- No change (or empty) despite filters applied.\\n\\nFiles to inspect\\n- public/app.js (getCurrentFilters, onApplyFilters)\\n- public/js/filters/builder.js (serviceIdsActive handling)\\n- public/js/map/utils.js (serviceIdsActive handling)\\n- public/js/state/manager.js (spatialQuery state lifecycle)","acceptance_criteria":"- Attribute filters (mode/operator/LA/RPT) correctly restrict table and map with spatial logic enabled/disabled.\\n- Spatial query match-set does not interfere when spatial tool is inactive.\\n- Regression test added to prevent recurrence.","notes":"Additional fix applied to prevent empty spatial queries from blocking other filters:\n\nModified public/js/state/manager.js setSpatialMatchSet() function (lines 160-179):\n- Changed logic to only set active: true when ids.length \u003e 0\n- Empty spatial queries now set active: false\n- This prevents empty match sets from applying WHERE FALSE and blocking attribute filters\n\nRoot cause: When spatial builder was initialized or reset, it would set an empty match set with active: true, causing serviceIdsActive to block all results even when spatial query wasn't being used.\n\nFix ensures spatial query state is properly inactive when no service IDs are matched.","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-12-25T23:27:23.48243Z","updated_at":"2025-12-28T13:04:38.282698Z","closed_at":"2025-12-28T09:41:45.659653Z","comments":[{"id":37,"issue_id":"NetworkView-4mh","author":"home","text":"Observed console errors: enable_external_access cannot be changed while DB running; spatial extension path duplicated (extensions/.duckdb/...) causing load failures; routes not rendering. Adjusted extension directory to absolute path in init/ensure to fix. Need to validate filters post-fix.","created_at":"2025-12-25T23:29:42Z"},{"id":38,"issue_id":"NetworkView-4mh","author":"home","text":"Bundled spatial extension locally (public/duckdb/extensions/v0.9.1/wasm_mvp/spatial.duckdb_extension), set spatialExtensionUrl to local path, and added fetch script. This should stop st_point errors due to missing extension. Need to re-test filters and map rendering after reload.","created_at":"2025-12-25T23:37:52Z"},{"id":46,"issue_id":"NetworkView-4mh","author":"home","text":"Code review: applySpatialLogic on builder onChange + point pick sets empty spatial match set -\u003e serviceIdsActive true + WHERE FALSE. This matches simple filters returning no results. Sources: public/app.js:2948-2957, public/app.js:2053-2060, public/js/spatial/execute.js, public/js/state/manager.js.","created_at":"2025-12-26T12:16:34Z"}]}
{"id":"NetworkView-4nj","title":"Phase 2: Styling presets","description":"Phase: Phase 2 — Map Viewer MVP (route lines + clip + filters + linked table) (5–10 days)\nSection: map rendering\nSource: plan.md\nDetails:\n- default colour by `mode`\n- optional colour by `operator_code` (advanced)","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-25T15:55:18.621207Z","updated_at":"2025-12-25T16:04:16.160229Z","labels":["phase-2"],"dependencies":[{"issue_id":"NetworkView-4nj","depends_on_id":"NetworkView-p57","type":"parent-child","created_at":"2025-12-25T16:04:16.621995Z","created_by":"daemon"}]}
{"id":"NetworkView-4uv","title":"Phase 2: Click-to-copy table cell","description":"Scope\n- Enable click-to-copy for Data Inspector table cells.\n- Provide a subtle affordance and confirmation (toast or inline).\n\nAcceptance\n- Clicking a cell copies its value to clipboard.\n- Non-copyable fields (e.g., geometry) are excluded.\n\nFiles\n- public/app.js (table render)\n","status":"closed","priority":2,"issue_type":"feature","created_at":"2025-12-25T20:35:30.171089Z","updated_at":"2025-12-26T00:11:00.210092Z","closed_at":"2025-12-26T00:11:00.210104Z","dependencies":[{"issue_id":"NetworkView-4uv","depends_on_id":"NetworkView-p57","type":"parent-child","created_at":"2025-12-25T20:35:30.729929Z","created_by":"daemon"}],"comments":[{"id":44,"issue_id":"NetworkView-4uv","author":"home","text":"Implemented click-to-copy for table cells (title + dataset + status feedback) and wired table-body click handler to copy values. Files: public/js/table/renderer.js, public/app.js. Tests: npm test -- --run.","created_at":"2025-12-26T00:09:19Z"}]}
{"id":"NetworkView-4x6","title":"Phase 2: Admin panel allows header customization","description":"Scope\n- Expose header content (title/kicker/badge) in admin config UI.\n- Persist to config (config.json/config.r2.json or admin backing store).\n\nAcceptance\n- Admin can edit header content and see it reflected in the UI.\n- Changes survive refresh and are included in exported config.\n","status":"open","priority":2,"issue_type":"feature","created_at":"2025-12-25T20:35:30.958821Z","updated_at":"2025-12-25T20:35:30.958821Z","dependencies":[{"issue_id":"NetworkView-4x6","depends_on_id":"NetworkView-p57","type":"parent-child","created_at":"2025-12-25T20:35:31.384581Z","created_by":"daemon"},{"issue_id":"NetworkView-4x6","depends_on_id":"NetworkView-3e6","type":"blocks","created_at":"2025-12-25T20:35:31.592755Z","created_by":"daemon"}]}
{"id":"NetworkView-587","title":"DuckDB spatial LA/RTP attribution","description":"Replace Python GeoPandas join with DuckDB spatial joins; add multi-membership LA/RTP fields and robust filtering.","status":"open","priority":1,"issue_type":"epic","created_at":"2025-12-25T17:43:26.309224Z","updated_at":"2025-12-25T17:43:26.309224Z","labels":["data","duckdb","phase1","spatial"]}
{"id":"NetworkView-587.1","title":"Audit current LA/RTP attribution pipeline","description":"Locate the current GeoPandas/Shapely join that writes la_code/rpt_code and document its rule + inputs/outputs.","status":"tombstone","priority":2,"issue_type":"task","created_at":"2025-12-25T17:43:30.271747Z","updated_at":"2025-12-25T22:16:51.656247Z","labels":["data","duckdb","spatial"],"dependencies":[{"issue_id":"NetworkView-587.1","depends_on_id":"NetworkView-587","type":"parent-child","created_at":"2025-12-25T17:43:30.274486Z","created_by":"daemon"}],"deleted_at":"2025-12-25T22:16:51.656247Z","deleted_by":"daemon","delete_reason":"delete","original_type":"task"}
{"id":"NetworkView-587.2","title":"Design DuckDB spatial join + multi-membership fields","description":"Specify DuckDB SQL to compute intersection length per route/LA and per route/RTP; define primary assignment and multi-membership fields with thresholds.","status":"open","priority":1,"issue_type":"task","created_at":"2025-12-25T17:43:35.416347Z","updated_at":"2025-12-25T17:43:35.416347Z","labels":["data","duckdb","spatial"],"dependencies":[{"issue_id":"NetworkView-587.2","depends_on_id":"NetworkView-587","type":"parent-child","created_at":"2025-12-25T17:43:35.419207Z","created_by":"daemon"}]}
{"id":"NetworkView-587.3","title":"Implement DuckDB-based generation + refresh artifacts","description":"Add a DuckDB spatial generation script to output routes.parquet/pmtiles with la_codes/rpt_codes; refresh metadata.json with thresholds and field definitions.","status":"open","priority":1,"issue_type":"task","created_at":"2025-12-25T17:43:40.798543Z","updated_at":"2025-12-25T17:43:40.798543Z","labels":["artifacts","data","duckdb","spatial"],"dependencies":[{"issue_id":"NetworkView-587.3","depends_on_id":"NetworkView-587","type":"parent-child","created_at":"2025-12-25T17:43:40.80121Z","created_by":"daemon"}]}
{"id":"NetworkView-587.4","title":"Update UI filters to use multi-membership fields","description":"Adjust map/table filtering to use la_codes/rpt_codes (contains match) with fallback to primary fields; update status/debug messaging.","status":"open","priority":1,"issue_type":"task","created_at":"2025-12-25T17:43:46.769462Z","updated_at":"2025-12-25T17:43:46.769462Z","labels":["duckdb","filters","frontend"],"dependencies":[{"issue_id":"NetworkView-587.4","depends_on_id":"NetworkView-587","type":"parent-child","created_at":"2025-12-25T17:43:46.77204Z","created_by":"daemon"}]}
{"id":"NetworkView-587.5","title":"Validate edge cases + document methodology","description":"Check Ember E1 and other multi-LA services; update BASELINE.md + plan.md with DuckDB spatial method + dependency notes.","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-25T17:43:53.018919Z","updated_at":"2025-12-25T17:43:53.018919Z","labels":["data","docs","spatial"],"dependencies":[{"issue_id":"NetworkView-587.5","depends_on_id":"NetworkView-587","type":"parent-child","created_at":"2025-12-25T17:43:53.02203Z","created_by":"daemon"}]}
{"id":"NetworkView-58f","title":"LA/RPT filters not applied until boundary filters populated","description":"Bug: LA/RPT selections do not filter map/table because populateBoundaryFilters was never invoked after DuckDB init. Fix: call populateBoundaryFilters after initDuckDb, add map-filter tests to assert LA/RPT string matching.","notes":"Fixed by calling populateBoundaryFilters after initDuckDb; added app wiring and map-utils tests to cover LA/RPT filter behavior.","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-12-25T20:53:42.181836Z","updated_at":"2025-12-25T20:53:47.54815Z","closed_at":"2025-12-25T20:53:47.548154Z"}
{"id":"NetworkView-5b7","title":"When a map feature is cliced on the map it should be highliighted and prioritied in the table view","description":"Feature: Map selection sync with table view\n\nSummary\nWhen a user clicks a feature on the map, that feature is visually highlighted and brought to the top of the table view.\n\nUser need\nUsers want to quickly see more detail about a map feature without having to search for it in a long table.\n\nBehaviour\n\nClicking a feature on the map selects it.\n\nThe selected feature is highlighted on the map using a clear visual state.\n\nThe same feature is highlighted in the table view.\n\nThe table automatically reorders so the selected feature appears at the top.\n\nIf multiple features are already sorted, the selected feature remains pinned above the existing sort order.\n\nClicking a different map feature updates both the map highlight and the table position.\n\nClicking away clears the selection and returns the table to its previous order.\n\nInteraction notes\n\nHighlighting should be subtle and consistent across map and table.\n\nThe interaction should feel instant, with no visible reload of the table.\n\nKeyboard and touch interactions should behave the same way as mouse clicks.\n\nValue\nThis reduces cognitive load, speeds up inspection of data, and keeps map and table views clearly in sync.","status":"open","priority":2,"issue_type":"feature","created_at":"2025-12-25T22:27:56.465124Z","updated_at":"2025-12-25T22:27:56.465124Z","comments":[{"id":45,"issue_id":"NetworkView-5b7","author":"home","text":"Map click now focuses the selected service in the table: selection triggers scroll-to-row (with DuckDB index lookup when needed) and table re-render. Applies to map tiles, preview GeoJSON, and deck overlay clicks. Files: public/app.js. Tests: npm test -- --run.","created_at":"2025-12-26T00:10:47Z"}]}
{"id":"NetworkView-5e4","title":"Accessibility: status live region + icon button labels","description":"Status and control affordances are not fully accessible. The status text updates are not announced to screen readers, and several icon-only buttons rely on title text only.\\n\\nContext:\\n- Status element: #status in public/index.html updates frequently via setStatus in public/app.js.\\n- Icon-only buttons: sidebar fullscreen, data inspector filter/expand, close buttons in mock panels.\\n\\nAcceptance criteria:\\n- Add aria-live (polite) and role=\"status\" to the status region.\\n- Add aria-labels to icon-only buttons (filter toggle, expand table, sidebar fullscreen, mock close buttons).\\n- Ensure focus styles are visible on keyboard navigation for key controls.\\n\\nFiles:\\n- public/index.html\\n- public/styles.css (if needed for focus styles)\\n","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-27T19:20:09.889488Z","updated_at":"2025-12-27T19:20:09.889488Z"}
{"id":"NetworkView-5iz","title":"Bug: Tooltips not working on spatial query action pills","description":"The title attributes added to the Include/Also Include/Exclude action pills in the spatial query builder are not displaying tooltips on hover. Need to investigate if this is a browser/CSS issue or if we need to implement a custom tooltip solution.","notes":"Fixed by implementing CSS tooltips using Tailwind group-hover pattern instead of native title attributes.\n\nChanges made to public/index.html (lines 293-324):\n- Added help icon with tooltip explaining Include (AND), Or Include (OR), Exclude (NOT) logic\n- Added individual tooltips to all three action buttons (Include, Or Include, Exclude)\n- Used invisible group-hover:visible pattern with absolute positioning\n- Tooltips appear on hover with dark background and clear explanations\n\nImplementation uses pure CSS (no JavaScript) and is accessible. Tooltips work correctly on hover.\n\nFiles modified:\n- public/index.html (spatial query builder section)","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-26T10:32:17.684675Z","updated_at":"2025-12-28T13:04:31.088162Z","closed_at":"2025-12-28T13:04:31.088559Z","labels":["bug","ui"]}
{"id":"NetworkView-5lx","title":"Phase 1: Source RPT boundaries (your dataset or external)","description":"Phase: Phase 1 — Data artefacts v1 (PMTiles + Parquet) (3–7 days)\nSection: boundaries\nSource: plan.md","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-25T15:55:14.853796Z","updated_at":"2025-12-25T16:09:36.926929Z","closed_at":"2025-12-25T16:09:36.926929Z","close_reason":"Closed","labels":["phase-1"],"dependencies":[{"issue_id":"NetworkView-5lx","depends_on_id":"NetworkView-gjy","type":"parent-child","created_at":"2025-12-25T16:04:25.206283Z","created_by":"daemon"}]}
{"id":"NetworkView-5tx","title":"Phase 3: Create Service Layer (Orchestration)","description":"## Goal\n\nCreate application layer for spatial query orchestration. This is MEDIUM RISK - we're adding new service layer alongside existing code.\n\n## Estimated Effort\n\n4-6 hours\n\n## What to Build\n\nCreate service layer in `public/js/spatial/application/`:\n\n### 1. spatial-service.js - Main Service\n\n**Purpose:** Orchestrate spatial query lifecycle (validate → compile → execute → update state)\n\n**Key Features:**\n- SpatialQueryService class\n- Handles concurrency (\"latest result wins\" with cancellation)\n- Caches compiled queries (performance optimization)\n- Manages execution state transitions\n- Emits events for side effects (NOT core logic)\n- Explicit error handling\n\n**Concurrency Handling:**\n```javascript\nasync executeQuery(query) {\n  // Cancel previous if still running\n  if (this.currentExecution) {\n    this.currentExecution.abort();\n  }\n  \n  const controller = new AbortController();\n  this.currentExecution = controller;\n  \n  // Execute with cancellation checks\n  // Update state only if not cancelled\n}\n```\n\n### 2. executor.js - Execution Helper\n\nOrchestrates: Build SQL → Execute query → Handle cancellation → Return metadata\n\n### 3. event-bus.js - Event Emitter\n\nLightweight event bus for service layer (isolated from global state)\n\n## Wiring into app.js\n\n**Feature Flag Pattern:**\n```javascript\nconst useNewArchitecture = state.config?.features?.spatial_new_architecture || false;\n\nif (useNewArchitecture) {\n  const spatialService = new SpatialQueryService({ state, eventBus, db });\n  // Wire event listeners\n} else {\n  // Keep existing code\n}\n```\n\n## Testing Strategy\n\nUnit tests with mocks + Integration tests with real modules\n\n## Acceptance Criteria\n\n- [ ] event-bus.js, executor.js, spatial-service.js created\n- [ ] Service handles concurrency (cancellation works)\n- [ ] Service caches compiled queries\n- [ ] Events emitted for side effects\n- [ ] Feature flag in config.json\n- [ ] Both architectures produce same results\n- [ ] All tests passing\n\n## References\n\nSPATIAL_ARCHITECTURE_REVIEW.md section: \"Service Layer\"\n\n## Parent Epic\n\nNetworkView-p5s\n\n## Depends On\n\nNetworkView-eij (Phase 1), NetworkView-94q (Phase 2)","notes":"Phase 3 complete. Created service layer (spatial-service) with 100% test coverage (17 tests). Orchestrates core + infrastructure layers. Supports cancellation (AbortController) and query caching. All existing tests still pass (249 total). Ready for Phase 4.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-28T20:11:12.334163Z","updated_at":"2025-12-29T16:09:29.737733Z","closed_at":"2025-12-29T16:09:29.737735Z","labels":["refactoring","service-layer","spatial"]}
{"id":"NetworkView-5ze","title":"Phase 2: PMTiles integration for routes + boundaries","description":"Phase: Phase 2 — Map Viewer MVP (route lines + clip + filters + linked table) (5–10 days)\nSection: map rendering\nSource: plan.md","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-25T15:55:18.383847Z","updated_at":"2025-12-25T16:04:16.820136Z","labels":["phase-2"],"dependencies":[{"issue_id":"NetworkView-5ze","depends_on_id":"NetworkView-p57","type":"parent-child","created_at":"2025-12-25T16:04:17.213398Z","created_by":"daemon"}]}
{"id":"NetworkView-6rf","title":"Phase 2: Table view (virtualised rows)","description":"Phase: Phase 2 — Map Viewer MVP (route lines + clip + filters + linked table) (5–10 days)\nSection: linked table\nSource: plan.md","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-25T15:55:21.244406Z","updated_at":"2025-12-25T16:25:08.891635Z","closed_at":"2025-12-25T16:25:08.891635Z","close_reason":"Closed","labels":["phase-2"],"dependencies":[{"issue_id":"NetworkView-6rf","depends_on_id":"NetworkView-p57","type":"parent-child","created_at":"2025-12-25T16:04:10.150527Z","created_by":"daemon"}],"comments":[{"id":1,"issue_id":"NetworkView-6rf","author":"home","text":"Implemented virtualized Data Inspector rows by rendering only visible slices with spacer rows and scroll-driven re-rendering; selection uses event delegation. Added configurable table limit via config.tableLimit (default 2000) so virtualization matters. Files: public/app.js, public/index.html, public/config*.json.","created_at":"2025-12-25T16:24:50Z"}]}
{"id":"NetworkView-6zj","title":"Phase 1: Generate `boundaries_la.pmtiles`","description":"Phase: Phase 1 — Data artefacts v1 (PMTiles + Parquet) (3–7 days)\nSection: boundaries\nSource: plan.md","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-25T15:55:15.425197Z","updated_at":"2025-12-25T16:09:36.930149Z","closed_at":"2025-12-25T16:09:36.930149Z","close_reason":"Closed","labels":["phase-1"],"dependencies":[{"issue_id":"NetworkView-6zj","depends_on_id":"NetworkView-gjy","type":"parent-child","created_at":"2025-12-25T16:04:24.01764Z","created_by":"daemon"}]}
{"id":"NetworkView-720","title":"Phase 1: Source Local Authority boundaries (your dataset or external)","description":"Phase: Phase 1 — Data artefacts v1 (PMTiles + Parquet) (3–7 days)\nSection: boundaries\nSource: plan.md","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-25T15:55:14.601098Z","updated_at":"2025-12-25T16:09:36.923995Z","closed_at":"2025-12-25T16:09:36.923995Z","close_reason":"Closed","labels":["phase-1"],"dependencies":[{"issue_id":"NetworkView-720","depends_on_id":"NetworkView-gjy","type":"parent-child","created_at":"2025-12-25T16:04:25.791933Z","created_by":"daemon"}]}
{"id":"NetworkView-79b","title":"SQ-07 Table restriction + CSV export parity","description":"Scope\n- Restrict Data Inspector table to match set.\n- Ensure CSV export uses same match set.\n\nAcceptance\n- Table row count matches map results.\n- CSV contains only matching routes.\n","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-25T17:33:24.231742Z","updated_at":"2025-12-25T17:33:24.231742Z","dependencies":[{"issue_id":"NetworkView-79b","depends_on_id":"NetworkView-3uh","type":"parent-child","created_at":"2025-12-25T17:33:24.652173Z","created_by":"daemon"}],"comments":[{"id":55,"issue_id":"NetworkView-79b","author":"home","text":"Validation note (2025-12-27): Ran Playwright on http://127.0.0.1:5137/. SQ panel opens and SLB controls are visible. 'Pick Point on Map' button present. No radius slider detected (input[type=range] count 0) and no visible Evidence text. Table rows remained 0 in my run, even after 'Load GeoJSON preview', so SQ execution/outputs could not be validated (map highlight, table restriction, CSV parity, evidence, edge cases). Screenshots in /tmp: sq-home.png, sq-panel.png, sq-validate-02-point.png, sq-validate-03-run.png, sq-sample-01-loaded.png, sq-sample-04-run.png. Please confirm data-populating environment for re-test.","created_at":"2025-12-27T19:47:12Z"},{"id":59,"issue_id":"NetworkView-79b","author":"home","text":"timestamp refresh","created_at":"2025-12-28T09:11:17Z"}]}
{"id":"NetworkView-7bs","title":"Phase 1: Generate `boundaries_rpt.pmtiles`","description":"Phase: Phase 1 — Data artefacts v1 (PMTiles + Parquet) (3–7 days)\nSection: boundaries\nSource: plan.md","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-25T15:55:15.696005Z","updated_at":"2025-12-25T16:09:36.931736Z","closed_at":"2025-12-25T16:09:36.931736Z","close_reason":"Closed","labels":["phase-1"],"dependencies":[{"issue_id":"NetworkView-7bs","depends_on_id":"NetworkView-gjy","type":"parent-child","created_at":"2025-12-25T16:04:23.399106Z","created_by":"daemon"}]}
{"id":"NetworkView-7l0","title":"DuckDB init: force buffer on localhost","description":"Local dev servers often lack Range support; force parquet buffering on localhost even if parquetPreferBuffer is false.","acceptance_criteria":"On localhost, DuckDB uses buffered parquet and shows status warning if parquetPreferBuffer was false.","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-12-25T19:56:41.693843Z","updated_at":"2025-12-25T19:57:13.230154Z","closed_at":"2025-12-25T19:57:13.230154Z","close_reason":"Closed","comments":[{"id":9,"issue_id":"NetworkView-7l0","author":"home","text":"Implemented localhost buffer override in DuckDB init; uses buffered parquet even if parquetPreferBuffer is false and emits status warning. Tests: npm test -- --run.","created_at":"2025-12-25T19:56:57Z"}]}
{"id":"NetworkView-7th","title":"Phase 2: Operator filter (typeahead multi-select)","description":"Phase: Phase 2 — Map Viewer MVP (route lines + clip + filters + linked table) (5–10 days)\nSection: filtering\nSource: plan.md","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-25T15:55:19.930745Z","updated_at":"2025-12-25T16:04:12.993176Z","labels":["phase-2"],"dependencies":[{"issue_id":"NetworkView-7th","depends_on_id":"NetworkView-p57","type":"parent-child","created_at":"2025-12-25T16:04:13.42907Z","created_by":"daemon"}]}
{"id":"NetworkView-7ug","title":"SLB-04 Evidence sentence + copy","description":"Scope\n- Generate plain-English sentence summary.\n- Include in Evidence panel and copy note.\n\nAcceptance\n- Evidence contains all blocks with parameters and thresholds.\n- Copy note is report-ready.\n","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-25T20:58:09.449431Z","updated_at":"2025-12-25T21:54:46.262576Z","closed_at":"2025-12-25T21:54:46.262576Z","close_reason":"Duplicate: evidence sentence handled in NetworkView-2k2","dependencies":[{"issue_id":"NetworkView-7ug","depends_on_id":"NetworkView-1tt","type":"parent-child","created_at":"2025-12-25T20:58:09.873649Z","created_by":"daemon"}],"comments":[{"id":21,"issue_id":"NetworkView-7ug","author":"home","text":"Design mockup available at public/design/index.html (served at /design/). May need edits to align with spec before wiring into app.","created_at":"2025-12-25T21:52:34Z"}]}
{"id":"NetworkView-7wl","title":"Add Playwright E2E filter test to CI","description":"Persist extended Playwright filter walkthrough and wire into CI to catch runtime filter regressions.","acceptance_criteria":"tests/e2e/filtering.e2e.js present, npm run test:e2e works, GitHub Actions runs e2e with Playwright.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-25T20:57:23.826964Z","updated_at":"2025-12-25T20:57:59.411664Z","closed_at":"2025-12-25T20:57:59.411664Z","close_reason":"Closed","comments":[{"id":13,"issue_id":"NetworkView-7wl","author":"home","text":"Added Playwright E2E filter walkthrough, wired into npm script and CI workflow. Unit tests run; e2e runs in CI with Playwright browsers.","created_at":"2025-12-25T20:57:40Z"}]}
{"id":"NetworkView-8ca","title":"Phase 1: Normalise and clean attributes","description":"Phase: Phase 1 — Data artefacts v1 (PMTiles + Parquet) (3–7 days)\nSection: route lines\nSource: plan.md\nDetails:\n- ensure stable `service_id`\n- ensure operator and mode values are consistent","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-25T15:55:16.17441Z","updated_at":"2025-12-25T16:09:36.934799Z","closed_at":"2025-12-25T16:09:36.934799Z","close_reason":"Closed","labels":["phase-1"],"dependencies":[{"issue_id":"NetworkView-8ca","depends_on_id":"NetworkView-gjy","type":"parent-child","created_at":"2025-12-25T16:04:22.165192Z","created_by":"daemon"}]}
{"id":"NetworkView-8z1","title":"Bug: Spatial query additional operations still overflowing","description":"The blocks container in the spatial query builder still appears to overflow despite adding max-h-40 and overflow-y-auto classes. The scrollable container may not be working as expected. Need to verify the HTML structure and ensure the scrollbar appears when there are many blocks.","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-26T10:32:18.117421Z","updated_at":"2025-12-26T10:32:18.117421Z","labels":["bug","ui"]}
{"id":"NetworkView-94q","title":"Phase 2: Extract Infrastructure (SQL/DuckDB)","description":"## Goal\n\nRefactor SQL generation and DuckDB execution to remove global state dependencies. This is MEDIUM RISK - we're changing existing modules but keeping compatibility.\n\n## Estimated Effort\n\n6-8 hours\n\n## What to Build\n\nRefactor 2 existing modules into `public/js/spatial/infrastructure/`:\n\n### 1. sql.js → infrastructure/sql-builder.js\n\n**Changes:**\n- Remove `import { state }` - accept context via parameter\n- Change function signatures to accept context object\n- Keep same SQL generation logic\n- Add explicit error messages when required context missing\n\n**Before:**\n```javascript\n// spatial/sql.js\nimport { state } from \"../state/manager.js\";\n\nexport const buildPointDistanceWhere = (point, distance, relation) =\u003e {\n  const useSpatial = state.spatialReady \u0026\u0026 state.geometryField; // Global access\n  // ...\n};\n```\n\n**After:**\n```javascript\n// spatial/infrastructure/sql-builder.js\n// No state import\n\nexport const buildPointDistanceWhere = (point, distance, relation, context) =\u003e {\n  const { spatialReady, geometryField, bboxReady, bboxFields } = context;\n  const useSpatial = spatialReady \u0026\u0026 geometryField; // From parameter\n  // ... same logic\n};\n```\n\n**Functions to refactor:**\n- buildPointDistanceWhere(point, distance, relation, context)\n- buildBoundaryWhere(operator, boundary, context)\n- buildAttributeWhere(operator, value, context)\n- buildSpatialWhere(compiled, point, context)\n- expandPointToBbox(point, distance) - no context needed, pure\n\n### 2. runner.js → infrastructure/duckdb-runner.js\n\n**Changes:**\n- Remove `import { state }` - accept db and context via parameters\n- Change loadSpatialLogicRunner to factory function\n- Accept signal for cancellation support\n- Return execution metadata (mode, time, post-filtered)\n\n**Before:**\n```javascript\n// spatial/runner.js\nimport { state } from \"../state/manager.js\";\n\nexport const loadSpatialLogicRunner = async (config, setStatus) =\u003e {\n  return {\n    async run(compiled, point, duckdb) {\n      const tableName = state.bboxReady ? \"routes_with_bbox\" : \"...\"; // Global\n      // ...\n    }\n  };\n};\n```\n\n**After:**\n```javascript\n// spatial/infrastructure/duckdb-runner.js\n// No state import\n\nexport const createDuckDBRunner = (db, context) =\u003e {\n  return {\n    async execute(whereClause, options) {\n      const { signal, needsPostFilter, point, distance } = options;\n      const { bboxReady, serviceIdField, geojsonField } = context;\n      \n      // Check cancellation\n      if (signal?.aborted) throw new Error(\"Query cancelled\");\n      \n      const tableName = bboxReady ? \"routes_with_bbox\" : \"...\"; // From context\n      // ... execute query\n      \n      return {\n        serviceIds: [...],\n        count: ...,\n        executionTime: ...,\n        postFiltered: ...\n      };\n    }\n  };\n};\n```\n\n## Compatibility Layer\n\nCreate `public/js/spatial/compatibility/adapter.js`:\n\n**Purpose:** Bridge between old and new infrastructure modules\n\n```javascript\n// compatibility/adapter.js\nimport { state } from \"../state/manager.js\";\nimport { buildSpatialWhere } from \"../infrastructure/sql-builder.js\";\nimport { createDuckDBRunner } from \"../infrastructure/duckdb-runner.js\";\n\n/**\n * Adapter for old code that doesn't pass context\n * Uses global state to build context (temporary)\n */\nexport const buildSpatialWhereCompat = (compiled, point) =\u003e {\n  const context = {\n    spatialReady: state.spatialReady,\n    geometryField: state.geometryField,\n    bboxReady: state.bboxReady,\n    bboxFields: state.bboxFields,\n    operatorFields: state.operatorFields,\n    modeField: state.modeField\n  };\n  return buildSpatialWhere(compiled, point, context);\n};\n\nexport const createRunnerCompat = (db, setStatus) =\u003e {\n  const context = {\n    bboxReady: state.bboxReady,\n    serviceIdField: state.serviceIdField,\n    geojsonField: state.geojsonField,\n    bboxFields: state.bboxFields\n  };\n  return createDuckDBRunner(db, context);\n};\n```\n\n**Update existing code to use adapter:**\n- runner.js → imports from adapter.js\n- app.js → imports from adapter.js (temporarily)\n\n## Refactoring Practices\n\n**CRITICAL - Follow AGENTS.md:**\n\n1. **Backup before changing:**\n   ```bash\n   cp public/js/spatial/sql.js /tmp/sql_backup.js\n   cp public/js/spatial/runner.js /tmp/runner_backup.js\n   ```\n\n2. **Find ALL call sites:**\n   ```bash\n   # Find all calls to buildSpatialWhere\n   grep -rn \"buildSpatialWhere\" public/\n   \n   # Find all calls to loadSpatialLogicRunner\n   grep -rn \"loadSpatialLogicRunner\\|runner\\.run\" public/\n   ```\n\n3. **Update signatures incrementally:**\n   - Create new infrastructure modules first\n   - Create compatibility adapter\n   - Update call sites one at a time\n   - Test after each update\n   - Remove old modules last\n\n4. **Verify no undefined errors:**\n   ```bash\n   # After changes, check browser console\n   # Look for \"is not defined\" errors\n   # Check Network tab - ensure new files loaded\n   ```\n\n5. **Test continuously:**\n   ```bash\n   # After EVERY change\n   npm test -- spatial-sql\n   \n   # Run in browser, check console\n   # Hard refresh: Cmd+Shift+R\n   ```\n\n6. **Git commits:**\n   ```bash\n   git add public/js/spatial/infrastructure/sql-builder.js tests/sql-builder.test.js\n   git commit -m \"Extract SQL builder to infrastructure layer\n\n   - Remove global state dependency\n   - Accept context via parameter\n   - Add tests for context-based SQL generation\n   - Keep compatibility with adapter\"\n   \n   git add public/js/spatial/infrastructure/duckdb-runner.js tests/duckdb-runner.test.js\n   git commit -m \"Extract DuckDB runner to infrastructure layer\n   \n   - Remove global state dependency\n   - Add cancellation support via AbortSignal\n   - Return execution metadata\n   - Keep compatibility with adapter\"\n   \n   git add public/js/spatial/compatibility/adapter.js\n   git commit -m \"Add compatibility adapter for gradual migration\n   \n   - Bridges old code to new infrastructure\n   - Uses global state temporarily\n   - Will be removed in Phase 5\"\n   ```\n\n## Testing Strategy\n\n**Update existing tests + add new ones:**\n\ntests/spatial-sql.test.js → tests/sql-builder.test.js:\n- Update to pass context parameter\n- Add tests for missing context (should error clearly)\n- Verify same SQL generated with context\n- Test cancellation support\n\nNew tests/duckdb-runner.test.js:\n- Test runner creation with context\n- Test cancellation via signal\n- Test execution metadata returned\n- Mock DuckDB connection\n\n**Run tests:**\n```bash\nnpm test -- sql-builder\nnpm test -- duckdb-runner\n\n# Verify all old tests still pass\nnpm test\n```\n\n## Acceptance Criteria\n\n- [ ] public/js/spatial/infrastructure/sql-builder.js created\n- [ ] public/js/spatial/infrastructure/duckdb-runner.js created\n- [ ] public/js/spatial/compatibility/adapter.js created\n- [ ] No direct state imports in infrastructure modules\n- [ ] All functions accept context via parameter\n- [ ] Cancellation support added (AbortSignal)\n- [ ] Tests updated and passing\n- [ ] Compatibility adapter tested with existing code\n- [ ] Browser console shows no errors\n- [ ] All 34+ existing tests still pass\n- [ ] Committed and pushed to branch\n\n## Call Site Updates\n\n**Files to check/update:**\n- public/js/spatial/runner.js (use adapter temporarily)\n- public/app.js (use adapter temporarily)\n- tests/spatial-sql.test.js (update to new signatures)\n\n**Pattern for updates:**\n```javascript\n// OLD\nconst sql = buildSpatialWhere(compiled, point);\n\n// NEW (via adapter - temporary)\nconst sql = buildSpatialWhereCompat(compiled, point);\n\n// FUTURE (Phase 5 - direct)\nconst context = getContext();\nconst sql = buildSpatialWhere(compiled, point, context);\n```\n\n## References\n\n- SPATIAL_ARCHITECTURE_REVIEW.md section: \"Executor (executor.js)\"\n- AGENTS.md section: \"Function Signature Migration Pattern\"\n\n## Parent Epic\n\nNetworkView-p5s (Spatial Query Module: Architectural Refactoring)\n\n## Depends On\n\nNetworkView-eij (Phase 1: Extract Core Domain)","notes":"Phase 2 complete. Created infrastructure modules (sql-builder, duckdb-runner) with 100% test coverage (42 tests). No changes to existing code. All existing tests still pass (193 total). Ready for Phase 3.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-28T20:06:21.384341Z","updated_at":"2025-12-29T15:20:38.747782Z","closed_at":"2025-12-29T15:20:38.747786Z","labels":["infrastructure","refactoring","spatial"]}
{"id":"NetworkView-952","title":"Phase 3: “Send to MapBuilder” stores a `MapArtefactDraft` (JSON spec)","description":"Phase: Phase 3 — Snapshot export + MapBuilder hand-off (3–7 days)\nSection: MapBuilder scaffold (minimal)\nSource: plan.md","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-25T15:55:23.5469Z","updated_at":"2025-12-25T16:04:03.253763Z","labels":["phase-3"],"dependencies":[{"issue_id":"NetworkView-952","depends_on_id":"NetworkView-wu5","type":"parent-child","created_at":"2025-12-25T16:04:03.700903Z","created_by":"daemon"}]}
{"id":"NetworkView-a1m","title":"Phase 0: Define central configuration","description":"Phase: Phase 0 — Repo + foundations (1–2 days)\nSource: plan.md\nDetails:\n- `config/definitions.json` (time bands, default styling, thresholds)\n- `config/sources.json` (dataset attribution, update frequency)","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-25T15:55:14.11075Z","updated_at":"2025-12-25T16:04:26.636723Z","closed_at":"2025-12-25T15:57:29.036625Z","labels":["phase-0"],"dependencies":[{"issue_id":"NetworkView-a1m","depends_on_id":"NetworkView-qnr","type":"parent-child","created_at":"2025-12-25T16:04:27.245563Z","created_by":"daemon"}]}
{"id":"NetworkView-a72","title":"SQ-04 Spatial logic selector + readable sentence","description":"Scope\n- Implement logic options:\n  1) NEAR(point, radius)\n  2) INTERSECTS(boundary)\n  3) NEAR(point, radius) AND INTERSECTS(boundary)\n- Render as human-readable sentence.\n\nAcceptance\n- Logic selector is plain English.\n- Active logic displayed (e.g., \"Routes within 300m of point AND intersect boundary\").\n","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-25T17:33:22.229755Z","updated_at":"2025-12-25T21:54:47.280839Z","closed_at":"2025-12-25T21:54:47.280839Z","close_reason":"Superseded by SLB-03 (builder handles logic selection + sentence)","dependencies":[{"issue_id":"NetworkView-a72","depends_on_id":"NetworkView-3uh","type":"parent-child","created_at":"2025-12-25T17:33:22.641143Z","created_by":"daemon"}],"comments":[{"id":17,"issue_id":"NetworkView-a72","author":"home","text":"Design mockup available at public/design/index.html (served at /design/). May need edits to align with spec before wiring into app.","created_at":"2025-12-25T21:52:33Z"}]}
{"id":"NetworkView-adx","title":"Phase 3 integration: fix filter wiring for table/export/service search","description":"Refactor moved filter helpers to modules; several call sites in app.js and table/export modules stopped passing UI inputs or filter objects, disabling filters or breaking exports.","acceptance_criteria":"Service search/operators/time bands apply in buildWhere/buildMapFilter; table paging and exports use current filters; download handlers wired with dependencies; no runtime errors from missing filter args.","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-12-25T19:46:56.299182Z","updated_at":"2025-12-25T19:47:33.744629Z","closed_at":"2025-12-25T19:47:33.744629Z","close_reason":"Closed","comments":[{"id":7,"issue_id":"NetworkView-adx","author":"home","text":"Fixed filter wiring after modular refactor: pass operator/time-band/service-search inputs through app.js, propagate filters into table paging/queryTable, and thread filters into export handlers. Updated download click handlers to provide dependencies. Tests: npm test -- --run.","created_at":"2025-12-25T19:47:17Z"}]}
{"id":"NetworkView-ags","title":"Phase 4: Add timetable-derived flags for time bands","description":"Phase: Phase 4 — Performance hardening + real time bands (as data allows) (ongoing)\nSource: plan.md\nDetails:\n- `runs_evening`, `runs_night`, `runs_sunday`","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-25T15:55:24.50867Z","updated_at":"2025-12-25T16:04:00.413425Z","labels":["phase-4"],"dependencies":[{"issue_id":"NetworkView-ags","depends_on_id":"NetworkView-zds","type":"parent-child","created_at":"2025-12-25T16:04:00.860123Z","created_by":"daemon"}]}
{"id":"NetworkView-b43","title":"Phase 1: Generate `routes.pmtiles` with above properties present on tile features","description":"Phase: Phase 1 — Data artefacts v1 (PMTiles + Parquet) (3–7 days)\nSection: route lines\nSource: plan.md","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-25T15:55:16.680558Z","updated_at":"2025-12-25T16:09:36.937554Z","closed_at":"2025-12-25T16:09:36.937554Z","close_reason":"Closed","labels":["phase-1"],"dependencies":[{"issue_id":"NetworkView-b43","depends_on_id":"NetworkView-gjy","type":"parent-child","created_at":"2025-12-25T16:04:20.953219Z","created_by":"daemon"}]}
{"id":"NetworkView-byi","title":"SQ-09 Edge cases + limits","description":"Scope\n- Handle no results, out-of-extent points, oversized boundaries.\n- Cap radius (e.g., 2km) and polygon complexity.\n- Provide user-friendly warnings.\n\nAcceptance\n- Clear guidance for zero results or slow queries.\n- Limits enforced without crashes.\n","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-25T17:33:25.595742Z","updated_at":"2025-12-25T17:33:25.595742Z","dependencies":[{"issue_id":"NetworkView-byi","depends_on_id":"NetworkView-3uh","type":"parent-child","created_at":"2025-12-25T17:33:25.996521Z","created_by":"daemon"}],"comments":[{"id":57,"issue_id":"NetworkView-byi","author":"home","text":"Validation note (2025-12-27): Ran Playwright on http://127.0.0.1:5137/. SQ panel opens and SLB controls are visible. 'Pick Point on Map' button present. No radius slider detected (input[type=range] count 0) and no visible Evidence text. Table rows remained 0 in my run, even after 'Load GeoJSON preview', so SQ execution/outputs could not be validated (map highlight, table restriction, CSV parity, evidence, edge cases). Screenshots in /tmp: sq-home.png, sq-panel.png, sq-validate-02-point.png, sq-validate-03-run.png, sq-sample-01-loaded.png, sq-sample-04-run.png. Please confirm data-populating environment for re-test.","created_at":"2025-12-27T19:47:23Z"}]}
{"id":"NetworkView-cbd","title":"Phase 2: Export current table to CSV (DuckDB query → CSV blob download)","description":"Phase: Phase 2 — Map Viewer MVP (route lines + clip + filters + linked table) (5–10 days)\nSection: exports\nSource: plan.md","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-25T15:55:22.227535Z","updated_at":"2025-12-25T16:34:06.603869Z","closed_at":"2025-12-25T16:34:06.603873Z","labels":["phase-2"],"dependencies":[{"issue_id":"NetworkView-cbd","depends_on_id":"NetworkView-p57","type":"parent-child","created_at":"2025-12-25T16:04:07.304927Z","created_by":"daemon"}]}
{"id":"NetworkView-ch4","title":"Phase 1: Generate `metadata.json` including","description":"Phase: Phase 1 — Data artefacts v1 (PMTiles + Parquet) (3–7 days)\nSection: metadata\nSource: plan.md\nDetails:\n- dataset versions (hash or timestamp)\n- generated-at time\n- attribution text\n- definitions.json version used","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-25T15:55:17.203208Z","updated_at":"2025-12-25T16:09:36.94057Z","closed_at":"2025-12-25T16:09:36.94057Z","close_reason":"Closed","labels":["phase-1"],"dependencies":[{"issue_id":"NetworkView-ch4","depends_on_id":"NetworkView-gjy","type":"parent-child","created_at":"2025-12-25T16:04:19.768896Z","created_by":"daemon"}]}
{"id":"NetworkView-cni","title":"Phase 4: Refactor UI Layer (Presentation Only)","description":"## Goal\n\nSeparate UI presentation from business logic in builder.js. This is HIGHER RISK - we're changing a large file with many responsibilities.\n\n## Estimated Effort\n\n8-12 hours\n\n## Current Problem\n\nbuilder.js (515 LOC) mixes:\n- UI rendering (DOM manipulation)\n- Event handling\n- Business logic (validation, compilation)\n- State management\n- External dependencies (metadata access)\n\n## What to Build\n\nSplit builder.js into focused modules:\n\n### 1. ui/builder-ui.js - Presentation Only\n\n**Responsibilities:**\n- DOM manipulation\n- Event listeners\n- UI state (local only - which tab, expanded sections)\n- Emit events (no direct calls to business logic)\n\n**Does NOT:**\n- Validate queries\n- Compile queries\n- Execute queries\n- Access global state directly\n\n**Pattern:**\n```javascript\nexport const createBuilderUI = (container, { onQueryChange, onRun, getMetadata }) =\u003e {\n  // UI elements\n  const elements = { /* ... */ };\n  \n  // Local UI state\n  const uiState = {\n    activeTab: \"builder\",\n    blocks: []\n  };\n  \n  // Event handlers emit events\n  elements.run.addEventListener(\"click\", () =\u003e {\n    const query = getCurrentQueryFromUI();\n    onRun(query); // Callback, not direct service call\n  });\n  \n  elements.distance.addEventListener(\"input\", () =\u003e {\n    const query = getCurrentQueryFromUI();\n    onQueryChange(query); // Callback\n  });\n  \n  return {\n    setQuery(query) { /* Update UI from query */ },\n    setError(errors) { /* Display validation errors */ },\n    disable() { /* Disable during execution */ },\n    enable() { /* Re-enable */ }\n  };\n};\n```\n\n### 2. ui/builder-state.js - Local UI State\n\n**Purpose:** Manage UI-specific state (not query state)\n\n```javascript\nexport const createBuilderState = () =\u003e {\n  const state = {\n    activeTab: \"builder\",\n    blocks: [],\n    expanded: true\n  };\n  \n  const listeners = [];\n  \n  return {\n    get() { return { ...state }; },\n    set(updates) {\n      Object.assign(state, updates);\n      listeners.forEach(cb =\u003e cb(state));\n    },\n    subscribe(callback) {\n      listeners.push(callback);\n      return () =\u003e {\n        const index = listeners.indexOf(callback);\n        if (index \u003e -1) listeners.splice(index, 1);\n      };\n    }\n  };\n};\n```\n\n### 3. Migration Strategy\n\n**Incremental Approach:**\n\n1. **Create new UI modules first** (don't delete builder.js yet)\n2. **Wire new UI behind feature flag**\n3. **Test both UIs side-by-side**\n4. **Migrate event handlers one at a time**\n5. **Remove old builder.js last**\n\n**Backup:**\n```bash\ncp public/js/spatial/builder.js /tmp/builder_original.js\n```\n\n**Extract functions incrementally:**\n```bash\n# 1. Extract DOM manipulation to builder-ui.js\n# 2. Extract state management to builder-state.js\n# 3. Move event handlers to builder-ui.js\n# 4. Replace business logic calls with callbacks\n\n# After each step, test:\nnpm test\n# Check browser console\n```\n\n### 4. Wiring Pattern\n\n**Old (builder.js):**\n```javascript\ninitSpatialLogicBuilder(container, {\n  onChange: (compiled) =\u003e { /* ... */ },\n  onRun: (compiled) =\u003e { /* ... */ }\n}, runner);\n```\n\n**New (builder-ui.js + service):**\n```javascript\nif (useNewArchitecture) {\n  const builderUI = createBuilderUI(container, {\n    onQueryChange: (query) =\u003e {\n      spatialService.updateQuery(query);\n    },\n    onRun: async (query) =\u003e {\n      const result = await spatialService.executeQuery(query);\n      if (!result.success) {\n        builderUI.setError(result.errors);\n      }\n    },\n    getMetadata: () =\u003e state.metadata\n  });\n  \n  // Subscribe to service events\n  spatialEventBus.on(\"spatial:complete\", () =\u003e {\n    builderUI.enable();\n  });\n  \n  spatialEventBus.on(\"spatial:error\", (error) =\u003e {\n    builderUI.setError([error.message]);\n    builderUI.enable();\n  });\n}\n```\n\n## Refactoring Practices\n\n**CRITICAL - Follow AGENTS.md:**\n\n1. **Never delete without verification:**\n   ```bash\n   # Before deleting ANY function from builder.js\n   grep -n \"^const functionName\\|^function functionName\" public/js/spatial/ui/*.js\n   \n   # Only delete if found in new modules\n   ```\n\n2. **Function signature migration:**\n   ```bash\n   # Find ALL references to builder functions\n   grep -rn \"initSpatialLogicBuilder\\|spatialBuilder\\.run\" public/\n   \n   # Update each call site\n   ```\n\n3. **Test after EVERY extraction:**\n   ```bash\n   # After extracting each function group\n   npm test\n   \n   # Check browser\n   # Hard refresh: Cmd+Shift+R\n   ```\n\n4. **Git commits (atomic):**\n   ```bash\n   git add public/js/spatial/ui/builder-state.js tests/builder-state.test.js\n   git commit -m \"Extract builder UI state management\n   \n   - Separate UI state from query state\n   - Observable pattern for UI updates\n   - Tests for state mutations\"\n   \n   git add public/js/spatial/ui/builder-ui.js tests/builder-ui.test.js\n   git commit -m \"Extract builder UI presentation layer\n   \n   - Pure presentation logic\n   - Event-driven callbacks\n   - No business logic\n   - DOM manipulation only\"\n   \n   git add public/app.js\n   git commit -m \"Wire new builder UI (behind feature flag)\n   \n   - Feature flag controls old vs new\n   - Both UIs functional\n   - No breaking changes\"\n   ```\n\n## Testing Strategy\n\n**UI Testing (with DOM):**\n```javascript\n// tests/builder-ui.test.js\nimport { JSDOM } from \"jsdom\";\n\ndescribe(\"Builder UI\", () =\u003e {\n  let container, builderUI;\n  \n  beforeEach(() =\u003e {\n    const dom = new JSDOM(`\u003cdiv id=\"slb-container\"\u003e\u003c/div\u003e`);\n    container = dom.window.document.getElementById(\"slb-container\");\n    \n    builderUI = createBuilderUI(container, {\n      onQueryChange: vi.fn(),\n      onRun: vi.fn(),\n      getMetadata: () =\u003e ({ modes: [\"Bus\"], operators: [] })\n    });\n  });\n  \n  it(\"should emit onQueryChange when distance changes\", () =\u003e {\n    const input = container.querySelector(\"#slb-distance\");\n    input.value = \"500\";\n    input.dispatchEvent(new Event(\"input\"));\n    \n    expect(onQueryChange).toHaveBeenCalledWith(\n      expect.objectContaining({ distance: 500 })\n    );\n  });\n  \n  it(\"should disable during execution\", () =\u003e {\n    builderUI.disable();\n    \n    const runButton = container.querySelector(\"#slb-run\");\n    expect(runButton.disabled).toBe(true);\n  });\n});\n```\n\n**Integration Testing:**\n```javascript\n// tests/builder-integration.test.js\ndescribe(\"Builder Integration\", () =\u003e {\n  it(\"should execute query when Run clicked\", async () =\u003e {\n    // Create service + UI\n    const service = new SpatialQueryService({ ... });\n    const ui = createBuilderUI(container, {\n      onRun: (q) =\u003e service.executeQuery(q),\n      // ...\n    });\n    \n    // Set point\n    state.spatial.ui.point = { lat: 55.9, lng: -3.1 };\n    \n    // Click Run\n    container.querySelector(\"#slb-run\").click();\n    \n    // Wait for execution\n    await waitFor(() =\u003e {\n      expect(state.spatial.execution.status).toBe(\"complete\");\n    });\n  });\n});\n```\n\n## Acceptance Criteria\n\n- [ ] public/js/spatial/ui/builder-ui.js created (presentation only)\n- [ ] public/js/spatial/ui/builder-state.js created (UI state only)\n- [ ] No business logic in UI modules\n- [ ] Event-driven callbacks (no direct service calls)\n- [ ] Tests passing (UI tests with DOM)\n- [ ] Wired behind feature flag\n- [ ] Both old and new UIs functional\n- [ ] No regression in existing functionality\n- [ ] All call sites verified (grep)\n- [ ] Committed and pushed\n\n## Call Site Verification\n\n**Before removing old builder.js:**\n```bash\n# Find ALL references\ngrep -rn \"initSpatialLogicBuilder\" public/\ngrep -rn \"spatialBuilder\\.\" public/\ngrep -rn \"builder\\.run\\|builder\\.compile\\|builder\\.state\" public/\n\n# Should only find:\n# - Feature flag section in app.js\n# - No other references\n\n# If found elsewhere, update first\n```\n\n## References\n\nSPATIAL_ARCHITECTURE_REVIEW.md section: \"Refactor UI Layer\"\nAGENTS.md section: \"Never Delete Without Verification\"\n\n## Parent Epic\n\nNetworkView-p5s\n\n## Depends On\n\nNetworkView-eij (Phase 1), NetworkView-94q (Phase 2), NetworkView-5tx (Phase 3)","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-28T20:15:25.429826Z","updated_at":"2025-12-30T13:56:53.536307Z","closed_at":"2025-12-30T13:56:53.536307Z","close_reason":"Phase 4 complete: UI layer (builder-ui.js) with 23 tests, 0 regressions","labels":["refactoring","spatial","ui-layer"]}
{"id":"NetworkView-d4s","title":"Cloud DB Migration","description":"Migrate DuckDB query execution from client-side (browser) to server-side (Cloudflare Workers) to reduce client data transfer from ~50MB to \u003c1MB per query. This will significantly improve scalability and performance for users on slow connections.","status":"open","priority":1,"issue_type":"epic","created_at":"2025-12-26T11:11:28.723721Z","updated_at":"2025-12-26T11:11:28.723721Z"}
{"id":"NetworkView-d4s.1","title":"Initialize Cloudflare Workers Project","description":"Create directory structure, wrangler.toml, package.json. Configure R2 bucket binding for accessing existing routes.parquet file.","status":"open","priority":1,"issue_type":"task","estimated_minutes":90,"created_at":"2025-12-26T11:12:14.975046Z","updated_at":"2025-12-26T11:12:14.975046Z","dependencies":[{"issue_id":"NetworkView-d4s.1","depends_on_id":"NetworkView-d4s","type":"parent-child","created_at":"2025-12-26T11:12:14.986596Z","created_by":"daemon"}]}
{"id":"NetworkView-d4s.10","title":"Documentation","description":"Update README with new architecture diagram. Document API endpoints and request/response formats. Add deployment guide for Cloudflare Workers setup.","status":"open","priority":2,"issue_type":"task","estimated_minutes":90,"created_at":"2025-12-26T11:12:19.426697Z","updated_at":"2025-12-26T11:12:19.426697Z","dependencies":[{"issue_id":"NetworkView-d4s.10","depends_on_id":"NetworkView-d4s","type":"parent-child","created_at":"2025-12-26T11:12:19.427865Z","created_by":"daemon"}]}
{"id":"NetworkView-d4s.11","title":"Modify Query Execution in Frontend","description":"Update app.js to call API instead of local DuckDB. Update export handlers in public/js/exports/handlers.js. Maintain backward compatibility with useWorkerApi flag.","status":"open","priority":1,"issue_type":"task","estimated_minutes":150,"created_at":"2025-12-26T11:12:28.681404Z","updated_at":"2025-12-26T11:12:28.681404Z","dependencies":[{"issue_id":"NetworkView-d4s.11","depends_on_id":"NetworkView-d4s","type":"parent-child","created_at":"2025-12-26T11:12:28.689984Z","created_by":"daemon"}]}
{"id":"NetworkView-d4s.2","title":"Port DuckDB Initialization to Worker","description":"Copy and adapt DuckDB client code from public/js/duckdb/client.js to Worker environment. Implement schema detection and handle Worker memory constraints (may need 512MB tier).","status":"open","priority":1,"issue_type":"task","estimated_minutes":240,"created_at":"2025-12-26T11:12:15.490237Z","updated_at":"2025-12-26T11:12:15.490237Z","dependencies":[{"issue_id":"NetworkView-d4s.2","depends_on_id":"NetworkView-d4s","type":"parent-child","created_at":"2025-12-26T11:12:15.49173Z","created_by":"daemon"}]}
{"id":"NetworkView-d4s.3","title":"Implement Filter Builder \u0026 Query Logic","description":"Port WHERE clause builder from public/js/filters/builder.js. Create query execution functions for count, table, stats, spatial, and exports. Add result serialization to JSON.","status":"open","priority":1,"issue_type":"task","estimated_minutes":180,"created_at":"2025-12-26T11:12:15.993373Z","updated_at":"2025-12-26T11:12:15.993373Z","dependencies":[{"issue_id":"NetworkView-d4s.3","depends_on_id":"NetworkView-d4s","type":"parent-child","created_at":"2025-12-26T11:12:16.002343Z","created_by":"daemon"}]}
{"id":"NetworkView-d4s.4","title":"Create Worker API Endpoints","description":"Implement request router and CORS handling. Add all API endpoints: /api/query/count, /api/query/table, /api/query/stats/*, /api/export/*. Add error handling and validation.","status":"open","priority":1,"issue_type":"task","estimated_minutes":180,"created_at":"2025-12-26T11:12:16.466213Z","updated_at":"2025-12-26T11:12:16.466213Z","dependencies":[{"issue_id":"NetworkView-d4s.4","depends_on_id":"NetworkView-d4s","type":"parent-child","created_at":"2025-12-26T11:12:16.469906Z","created_by":"daemon"}]}
{"id":"NetworkView-d4s.5","title":"Update Frontend API Client","description":"Add API configuration to config.json and config.r2.json. Create new API client module in public/js/api/client.js. Add useWorkerApi feature flag.","status":"open","priority":1,"issue_type":"task","estimated_minutes":120,"created_at":"2025-12-26T11:12:16.957766Z","updated_at":"2025-12-26T11:12:16.957766Z","dependencies":[{"issue_id":"NetworkView-d4s.5","depends_on_id":"NetworkView-d4s","type":"parent-child","created_at":"2025-12-26T11:12:16.959299Z","created_by":"daemon"}]}
{"id":"NetworkView-d4s.7","title":"Deploy Worker to Production","description":"Deploy Worker with wrangler deploy. Configure custom domain (e.g., api.networkview.example.com). Update production config (config.r2.json) with Worker API URL.","status":"open","priority":1,"issue_type":"task","estimated_minutes":120,"created_at":"2025-12-26T11:12:18.083373Z","updated_at":"2025-12-26T11:12:18.083373Z","dependencies":[{"issue_id":"NetworkView-d4s.7","depends_on_id":"NetworkView-d4s","type":"parent-child","created_at":"2025-12-26T11:12:18.091748Z","created_by":"daemon"}]}
{"id":"NetworkView-d4s.8","title":"End-to-End Testing","description":"Test all features with Worker API: filters, pagination, service search, spatial queries, exports. Performance testing (target \u003c1s response). Error handling validation.","status":"open","priority":1,"issue_type":"task","estimated_minutes":180,"created_at":"2025-12-26T11:12:18.515143Z","updated_at":"2025-12-26T11:12:18.515143Z","dependencies":[{"issue_id":"NetworkView-d4s.8","depends_on_id":"NetworkView-d4s","type":"parent-child","created_at":"2025-12-26T11:12:18.516343Z","created_by":"daemon"}]}
{"id":"NetworkView-d4s.9","title":"Optimization \u0026 Monitoring","description":"Implement result caching for common queries. Add Worker analytics dashboard. Clean up unused client-side DuckDB code (~5-10MB savings). Optimize parquet access patterns.","status":"open","priority":2,"issue_type":"task","estimated_minutes":120,"created_at":"2025-12-26T11:12:18.955148Z","updated_at":"2025-12-26T11:12:18.955148Z","dependencies":[{"issue_id":"NetworkView-d4s.9","depends_on_id":"NetworkView-d4s","type":"parent-child","created_at":"2025-12-26T11:12:18.956373Z","created_by":"daemon"}]}
{"id":"NetworkView-dlm","title":"Filter controls inconsistent (auto-fit jumping, Clear leaves empty table, map filter sometimes not applied)","description":"User reports weird filter behaviour. Audit each control: Mode/Operator/Time band (multi-select), LA/RPT (single), service search, viewport limit checkbox, Clear/Reset.\n\nProblems observed in code:\n- Any filter apply triggers fitMapToScope(), which is jarring once filters auto-apply on change.\n- Clear/Reset currently empties table/stats and does not reload full dataset.\n- Map filter can be a no-op when selected filters exist but tileFields have not been detected (buildMapFilter returns null).\n\nExpected:\n- Changing filter controls updates map + table consistently.\n- Auto-apply on change should not re-fit map each time (only on explicit Apply if desired).\n- Clear/Reset restores full dataset counts/table.\n- Map filtering should retry tile-field detection when filters are set.","acceptance_criteria":"- Changing each filter control (Mode/Operator/Time band/LA/RPT/service search/bbox) updates both map and table.\n- Map only auto-fits on explicit Apply (or behind a flag), not on every change.\n- Clear/Reset restores full selection (non-zero rows) when data exists.\n- Map filtering works even when tileFields start empty (detect/retry), and selection highlight stays constrained.","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-12-25T17:26:05.345306Z","updated_at":"2025-12-25T17:28:27.87544Z","closed_at":"2025-12-25T17:28:27.87544Z","close_reason":"Closed","labels":["filters","phase-2","ui"],"comments":[{"id":4,"issue_id":"NetworkView-dlm","author":"home","text":"Audit + fixes in public/app.js:\n- Only explicit Apply button triggers auto-fit (onApplyFilters({autoFit:true})); auto-apply changes no longer jump the map.\n- Clear/Reset now reloads the full dataset by calling onApplyFilters({autoFit:false}) instead of leaving table empty.\n- applyMapFilters() retries detectTileFieldsFromRendered() when filters are set but buildMapFilter() returns null; adds one-time warning/log if tile attributes still can’t be detected.\n- Map filter match logic now supports selecting '(unknown)' for Mode/Operator (NONE_OPTION_VALUE) so map and table semantics match.\nRan: node --check public/app.js.","created_at":"2025-12-25T17:28:13Z"}]}
{"id":"NetworkView-dmc","title":"Phase 0: Decide dev server + build system","description":"Phase: Phase 0 — Repo + foundations (1–2 days)\nSource: plan.md\nDetails:\n- Vite + React + TypeScript (recommended for simplicity)","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-25T15:55:14.354109Z","updated_at":"2025-12-25T16:04:25.995408Z","closed_at":"2025-12-25T15:57:27.582199Z","labels":["phase-0"],"dependencies":[{"issue_id":"NetworkView-dmc","depends_on_id":"NetworkView-qnr","type":"parent-child","created_at":"2025-12-25T16:04:26.409903Z","created_by":"daemon"}]}
{"id":"NetworkView-dp1","title":"Phase 4: Add graceful degradation","description":"Phase: Phase 4 — Performance hardening + real time bands (as data allows) (ongoing)\nSource: plan.md\nDetails:\n- missing links → hide actions\n- missing time flags → disable filter with explanation","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-25T15:55:25.045658Z","updated_at":"2025-12-25T16:03:58.558493Z","labels":["phase-4"],"dependencies":[{"issue_id":"NetworkView-dp1","depends_on_id":"NetworkView-zds","type":"parent-child","created_at":"2025-12-25T16:03:59.54291Z","created_by":"daemon"}]}
{"id":"NetworkView-ds9","title":"Phase 2: Admin panel changes apply globally","description":"Scope\n- Ensure admin panel changes affect all users/sessions (not just local state).\n- Define persistence (e.g., config file write + reload, or shared store).\n\nAcceptance\n- Changes made by admin are visible to other users after reload.\n- Clear indication of when a change is live.\n","status":"open","priority":2,"issue_type":"feature","created_at":"2025-12-25T20:35:31.819055Z","updated_at":"2025-12-25T20:35:31.819055Z","dependencies":[{"issue_id":"NetworkView-ds9","depends_on_id":"NetworkView-p57","type":"parent-child","created_at":"2025-12-25T20:35:32.243008Z","created_by":"daemon"},{"issue_id":"NetworkView-ds9","depends_on_id":"NetworkView-3e6","type":"blocks","created_at":"2025-12-25T20:35:32.459596Z","created_by":"daemon"}]}
{"id":"NetworkView-eds","title":"Boundary filters only match origin routes","description":"Summary\n- LA/RPT boundary filters highlight a matching route set for one boundary code only (service start), so segments that also appear in the boundary but originate elsewhere never appear in filtered results.\n\nSteps\n1. Load the app with LA/RPT boundary filters enabled.\n2. Pick a service that starts in Edinburgh but also passes through Aberdeen (or vice versa).\n3. Apply the EDF boundary filter (Aberdeen or Edinburgh) and observe that the service appears only in its origin boundary and not in the other attachment even though the route passes through it.\n\nExpected\n- A route that intersects multiple boundary clips should appear in each clip where it has coverage (e.g., services touching both Edinburgh and Aberdeen shown when filtering either boundary).\n\nActual\n- The map/table only show the route when filtering its start boundary; the same service disappears when filtering the destination or any additional boundary.\n\nNotes\n- This should match the real-world 1→many relationship between routes and boundaries.\n- Likely a defect in the boundary match SQL or service_id join (current filters assume 1:1 origin match).","status":"open","priority":2,"issue_type":"bug","created_at":"2025-12-28T09:41:10.48575Z","updated_at":"2025-12-28T09:41:10.48575Z","comments":[{"id":61,"issue_id":"NetworkView-eds","author":"home","text":"Plan\n1. Reproduce by logging  after filters fire and sampling /tiles to confirm whether / are detected; this tells us if membership columns reach the frontend or are being dropped before filters run.\n2. If membership fields are missing, regenerate the artifacts via  (which already emits /) and the tippecanoe tiles so  contains the pipe-delimited arrays; verify  and  can find the columns (, ).\n3. Harden the filters: ensure  prefers / (with the  match) and  uses the membership field when building MapLibre expressions; add regression coverage in  and  so a route touching both Edinburgh and Aberdeen shows up when either boundary is selected.","created_at":"2025-12-28T09:47:45Z"},{"id":62,"issue_id":"NetworkView-eds","author":"home","text":"Plan\n1. Reproduce by logging `state.tileFields` after filters fire and sampling `routes.parquet`/tiles to confirm whether `la_codes`/`rpt_codes` are detected; this tells us if membership columns reach the frontend or are being dropped before filters run.\n2. If membership fields are missing, regenerate the artifacts via `tools/build_frontend_data.py` (which already emits `la_membership`/`rpt_membership`) and the tippecanoe tiles so `routes.pmtiles` contains the pipe-delimited arrays; verify `public/js/duckdb/client.js` and `state.tileFields` can find the columns (`laCodes`, `rptCodes`).\n3. Harden the filters: ensure `public/js/filters/builder.js` prefers `la_codes`/`rpt_codes` (with the `%|code|%` match) and `public/js/map/utils.js` uses the membership field when building MapLibre expressions; add regression coverage in `tests/filters.test.js` and `tests/map-utils.test.js` so a route touching both Edinburgh and Aberdeen shows up when either boundary is selected.","created_at":"2025-12-28T09:48:05Z"},{"id":63,"issue_id":"NetworkView-eds","author":"home","text":"Implemented the DuckDB spatial join path for LA/RPT filters, registering boundary parquets and adding configuration + tests so ST_Intersects clauses now cover Edinburgh/Aberdeen services. Tests: npm test -- filters.","created_at":"2025-12-28T10:11:40Z"},{"id":64,"issue_id":"NetworkView-eds","author":"home","text":"Handled missing boundary parquet artifacts:  now swallows fetch failures (logs warn) so dropdowns still populate even when the parquets aren’t shipped, preventing DuckDB init from halting.","created_at":"2025-12-28T10:12:58Z"},{"id":65,"issue_id":"NetworkView-eds","author":"home","text":"Handled boundary parquet fetch failures so DuckDB init no longer aborts when the data files are absent;  logs a warning and proceeds.","created_at":"2025-12-28T10:13:08Z"},{"id":66,"issue_id":"NetworkView-eds","author":"home","text":"Handled boundary parquet fetch failures so DuckDB init no longer aborts when the data files are absent; registerParquetArtifact now logs a warning and proceeds.","created_at":"2025-12-28T10:13:21Z"},{"id":67,"issue_id":"NetworkView-eds","author":"home","text":"Added boundary parquet readiness flags and boundary artifact registration feedback: spatial clauses now only run when DuckDB confirmed the parquet load succeeded, so dropdown filtering falls back without throwing  errors when files are missing.","created_at":"2025-12-28T10:31:01Z"},{"id":68,"issue_id":"NetworkView-eds","author":"home","text":"Added boundary parquet readiness flags and boundary artifact registration feedback: spatial clauses now only run when DuckDB confirmed the parquet load succeeded, so dropdown filtering falls back without throwing errors when files are missing.","created_at":"2025-12-28T10:31:12Z"}]}
{"id":"NetworkView-ega","title":"Phase 1: Compute primary `la_code` and `rpt_code` per route line (recommended v1 approach)","description":"Phase: Phase 1 — Data artefacts v1 (PMTiles + Parquet) (3–7 days)\nSection: route lines\nSource: plan.md\nDetails:\n- choose a deterministic rule (e.g., max intersect length)","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-25T15:55:16.42586Z","updated_at":"2025-12-25T16:09:36.936153Z","closed_at":"2025-12-25T16:09:36.936153Z","close_reason":"Closed","labels":["phase-1"],"dependencies":[{"issue_id":"NetworkView-ega","depends_on_id":"NetworkView-gjy","type":"parent-child","created_at":"2025-12-25T16:04:21.550352Z","created_by":"daemon"}]}
{"id":"NetworkView-eij","title":"Phase 1: Extract Core Domain (Pure Logic)","description":"## Goal\n\nCreate pure domain modules for spatial queries WITHOUT changing existing code. This phase is LOW RISK - we're only adding new modules, not modifying anything.\n\n## Estimated Effort\n\n4-6 hours\n\n## What to Build\n\nCreate 3 new modules in `public/js/spatial/core/`:\n\n### 1. query.js - Domain Model\n\n**Purpose:** Pure data structure for spatial queries\n\n**Key Features:**\n- SpatialQuery class with constructor\n- toJSON() / fromJSON() for serialization\n- describe() for human-readable description\n- No dependencies on global state or DOM\n\n**Example:**\n```javascript\nexport class SpatialQuery {\n  constructor({ find, condition, distance, target, blocks = [] }) {\n    this.find = find;\n    this.condition = condition;\n    this.distance = distance;\n    this.target = target;\n    this.blocks = blocks;\n  }\n  \n  toJSON() { /* serialize */ }\n  static fromJSON(obj) { /* deserialize */ }\n  describe() { /* human-readable string */ }\n}\n```\n\n### 2. validator.js - Validation Logic\n\n**Purpose:** Validate queries before execution\n\n**Key Features:**\n- validateQuery(query, context) returns array of error strings\n- assertValid(query, context) throws ValidationError\n- Context includes { point, boundary, spatialReady }\n- Validation rules:\n  - Required fields (find, target, distance \u003e= 0)\n  - Target-specific (point required for selected_point)\n  - Block validation (type, operator, value)\n  - Controlled impurity accepted (checks spatialReady)\n\n**Example:**\n```javascript\nexport const validateQuery = (query, context = {}) =\u003e {\n  const errors = [];\n  if (!query.find) errors.push(\"'find' is required\");\n  if (query.target === \"selected_point\" \u0026\u0026 !context.point) {\n    errors.push(\"Point required for selected_point target\");\n  }\n  // ... more validation\n  return errors;\n};\n```\n\n### 3. compiler.js - Query Compilation\n\n**Purpose:** Transform query to execution format\n\n**Key Features:**\n- compileQuery(query, context) returns compiled object\n- Versioned contract (semver: \"1.0.0\")\n- Hash for caching (hashQuery helper)\n- Metadata includes compilation context\n- Calls assertValid() before compiling\n\n**Example:**\n```javascript\nexport const compileQuery = (query, context = {}) =\u003e {\n  assertValid(query, context);\n  \n  return {\n    version: \"1.0.0\",\n    find: query.find,\n    blocks: [/* transformed blocks */],\n    metadata: { compiled_at, context },\n    hash: hashQuery(query)\n  };\n};\n```\n\n## Refactoring Practices\n\n**CRITICAL - Follow AGENTS.md:**\n\n1. **Do NOT modify existing code** - Only create new files\n2. **Backup before starting:**\n   ```bash\n   cp -r public/js/spatial /tmp/spatial_backup\n   ```\n\n3. **Test-driven development:**\n   - Write tests FIRST in tests/spatial-core.test.js\n   - Aim for 100% coverage on these modules\n   - Run `npm test -- spatial-core` after each function\n\n4. **No global state access:**\n   - No `import { state }` from state/manager.js\n   - All dependencies via parameters\n   - Pure functions only (except validation context checks)\n\n5. **Document controlled impurity:**\n   ```javascript\n   // NOTE: This validation has controlled impurity - it checks\n   // context.spatialReady which is infrastructure state.\n   // This is acceptable because spatial availability is a\n   // runtime infrastructure concern.\n   ```\n\n6. **Git workflow:**\n   ```bash\n   git checkout -b spatial-refactor-phase1\n   \n   # Commit each module separately\n   git add public/js/spatial/core/query.js tests/spatial-core.test.js\n   git commit -m \"Add SpatialQuery domain model with tests\"\n   \n   git add public/js/spatial/core/validator.js tests/spatial-validator.test.js\n   git commit -m \"Add query validation with comprehensive tests\"\n   \n   git add public/js/spatial/core/compiler.js tests/spatial-compiler.test.js\n   git commit -m \"Add query compiler with caching and versioning\"\n   ```\n\n## Testing Strategy\n\n**Target: 100% coverage for core domain**\n\nTest files to create:\n- tests/spatial-core.test.js (query model)\n- tests/spatial-validator.test.js (validation)\n- tests/spatial-compiler.test.js (compilation)\n\n**Test scenarios:**\n\nQuery Model:\n- Constructor sets properties correctly\n- toJSON() serializes all fields\n- fromJSON() deserializes correctly\n- describe() generates readable string\n- Handles blocks array\n\nValidator:\n- Required field validation\n- Distance validation (non-negative, number)\n- Target-specific validation (point, boundary)\n- Block validation (type, operator, value)\n- Returns empty array for valid query\n- Returns multiple errors for invalid query\n\nCompiler:\n- Validates before compiling\n- Throws ValidationError for invalid query\n- Returns versioned contract\n- Includes compilation metadata\n- Hash is stable for same query\n- Hash differs for different queries\n\n**Run tests:**\n```bash\nnpm test -- spatial-core\nnpm test -- spatial-validator  \nnpm test -- spatial-compiler\n\n# Verify 100% coverage\nnpm run test:coverage\n```\n\n## Acceptance Criteria\n\n- [ ] public/js/spatial/core/query.js created with SpatialQuery class\n- [ ] public/js/spatial/core/validator.js created with validation functions\n- [ ] public/js/spatial/core/compiler.js created with compilation logic\n- [ ] tests/spatial-core.test.js with 100% coverage of query.js\n- [ ] tests/spatial-validator.test.js with 100% coverage of validator.js\n- [ ] tests/spatial-compiler.test.js with 100% coverage of compiler.js\n- [ ] All new tests passing (npm test)\n- [ ] No changes to existing code (git diff shows only new files)\n- [ ] Documentation added to each module (JSDoc comments)\n- [ ] Committed and pushed to branch spatial-refactor-phase1\n\n## No Breaking Changes\n\nThis phase should NOT affect existing functionality:\n- Existing spatial queries still work\n- builder.js unchanged\n- runner.js unchanged\n- app.js unchanged\n- All 34 existing tests still pass\n\n## References\n\n- SPATIAL_ARCHITECTURE_REVIEW.md sections: \"Core Domain Models\"\n- AGENTS.md section: \"Code Housekeeping \u0026 Structure Requirements\"\n\n## Parent Epic\n\nNetworkView-p5s (Spatial Query Module: Architectural Refactoring)","notes":"Phase 1 complete. Created core domain modules (query, validator, compiler) with 100% test coverage (39 tests). No changes to existing code. All existing tests still pass (190 total). Ready for Phase 2.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-28T20:05:07.367611Z","updated_at":"2025-12-29T14:25:55.488647Z","closed_at":"2025-12-29T14:25:55.488782Z","labels":["core-domain","refactoring","spatial"]}
{"id":"NetworkView-gdk","title":"Phase 2: Service search (route number/name)","description":"Phase: Phase 2 — Map Viewer MVP (route lines + clip + filters + linked table) (5–10 days)\nSection: filtering\nSource: plan.md","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-25T15:55:20.173201Z","updated_at":"2025-12-25T16:04:12.345789Z","labels":["phase-2"],"dependencies":[{"issue_id":"NetworkView-gdk","depends_on_id":"NetworkView-p57","type":"parent-child","created_at":"2025-12-25T16:04:12.753885Z","created_by":"daemon"}]}
{"id":"NetworkView-gi4","title":"Phase 2: Map ↔ table selection (service_id links)","description":"Phase: Phase 2 — Map Viewer MVP (route lines + clip + filters + linked table) (5–10 days)\nSection: linked table\nSource: plan.md","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-25T15:55:21.487396Z","updated_at":"2025-12-25T16:04:08.973593Z","labels":["phase-2"],"dependencies":[{"issue_id":"NetworkView-gi4","depends_on_id":"NetworkView-p57","type":"parent-child","created_at":"2025-12-25T16:04:09.42372Z","created_by":"daemon"}]}
{"id":"NetworkView-gjy","title":"Epic: Phase 1 — Data artefacts v1 (PMTiles + Parquet) (3–7 days)","description":"Goal: route lines and boundaries are served as PMTiles; attribute tables exist as Parquet for DuckDB.\nDeliverables:\n- `routes.pmtiles`, `boundaries_la.pmtiles`, `boundaries_rpt.pmtiles`\n- `routes.parquet`, `operators.parquet` (if available)\n- `metadata.json`\nAcceptance:\n- PMTiles open in a simple MapLibre test page and render at national scale\n- DuckDB-WASM can query `routes.parquet` locally and return counts by operator/mode\nSource: plan.md","status":"open","priority":1,"issue_type":"epic","created_at":"2025-12-25T16:03:57.143933Z","updated_at":"2025-12-25T16:03:57.143933Z","labels":["phase-1"]}
{"id":"NetworkView-gwk","title":"LIMIT TO MAP VIEWPOINT not working","description":"the associated checkbox has no function","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-12-25T16:44:43.857416Z","updated_at":"2025-12-25T23:48:35.353689Z","closed_at":"2025-12-25T23:48:35.353695Z","comments":[{"id":40,"issue_id":"NetworkView-gwk","author":"home","text":"Applied viewport filtering to DuckDB count/table/stats/exports via buildCombinedWhere, and expanded bbox filter to use spatial geometry when available. Added tests for bbox/combined where. Files: public/app.js, public/js/filters/builder.js, public/js/table/renderer.js, public/js/exports/handlers.js, tests/filters.test.js. Tests: npm test.","created_at":"2025-12-25T23:48:01Z"}]}
{"id":"NetworkView-h93","title":"User Console log","description":"The user should be able to access an operation console log, showing information about their session, their queries (spatial or just basic filters) and any errors. This should be accessed by clicking a console icon in the bottom right. This should be unique to the users current session","status":"open","priority":2,"issue_type":"feature","created_at":"2025-12-25T17:39:22.028259Z","updated_at":"2025-12-25T22:21:04.600105Z"}
{"id":"NetworkView-haw","title":"SQ-02 Point placement + radius overlay","description":"Scope\n- Allow point placement by map click or search result hook.\n- Show draggable marker.\n- Add radius slider (default) and render buffer circle.\n\nAcceptance\n- Marker appears and can be moved.\n- Radius updates visually as slider moves.\n- Coordinates recorded for evidence.\n\nNotes\n- Default radius to be confirmed (100–400m).\n","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-25T17:33:20.89745Z","updated_at":"2025-12-28T14:24:09.127829Z","closed_at":"2025-12-28T14:24:09.127829Z","close_reason":"Closed","dependencies":[{"issue_id":"NetworkView-haw","depends_on_id":"NetworkView-3uh","type":"parent-child","created_at":"2025-12-25T17:33:21.330693Z","created_by":"daemon"}],"comments":[{"id":51,"issue_id":"NetworkView-haw","author":"home","text":"Validation note (2025-12-27): Ran Playwright on http://127.0.0.1:5137/. SQ panel opens and SLB controls are visible. 'Pick Point on Map' button present. No radius slider detected (input[type=range] count 0) and no visible Evidence text. Table rows remained 0 in my run, even after 'Load GeoJSON preview', so SQ execution/outputs could not be validated (map highlight, table restriction, CSV parity, evidence, edge cases). Screenshots in /tmp: sq-home.png, sq-panel.png, sq-validate-02-point.png, sq-validate-03-run.png, sq-sample-01-loaded.png, sq-sample-04-run.png. Please confirm data-populating environment for re-test.","created_at":"2025-12-27T19:46:51Z"},{"id":71,"issue_id":"NetworkView-haw","author":"home","text":"COMPLETED\n\nImplementation:\n✅ Draggable marker - Point can be moved after placement\n  - Hover shows grab cursor\n  - Mousedown starts drag, cursor changes to grabbing\n  - Map panning disabled during drag\n  - Live position updates during drag\n  - Auto re-runs query on drag end (app.js:2143-2184)\n\n✅ Visual radius circle overlay\n  - Circle updates in real-time as point is dragged\n  - Circle updates when distance slider changes\n  - Uses createCirclePolygon() from geometry utils\n  - SPATIAL_RADIUS layer with blue line (app.js:2130-2140)\n\n✅ Live distance slider integration\n  - Distance input triggers onDistanceChange handler (builder.js:423-426)\n  - Handler calls updateSpatialPointOverlay() (app.js:2988-2990)\n  - Radius circle redraws immediately as slider moves\n\n✅ Cursor feedback for point picking mode\n  - Crosshair cursor when in picking mode (app.js:3042-3044)\n  - Cursor resets after point selected (app.js:2049)\n  - Grab/grabbing cursors during drag (app.js:2145-2156)\n\n✅ Point coordinates display\n  - Updates via updateSpatialPointLabel() (app.js:123-128)\n  - Shows in [data-slb-point-label] element\n  - Updates during drag and after placement\n\nFiles modified:\n- public/app.js: Added drag handlers, cursor feedback, distance change handler\n- public/js/spatial/builder.js: Added onDistanceChange callback\n\nAll 151 tests passing ✅","created_at":"2025-12-28T14:24:04Z"}]}
{"id":"NetworkView-hf0","title":"Map misses scope-selected service","description":"## Summary\\nSelecting a specific service via the scope search updates the results table correctly, but the map still renders the full dataset instead of highlighting the scoped service. The UI needs to keep the map and table in sync when scope search restricts to one service.\\n\\n## Steps to Reproduce\\n1. Run scope search for a known service (e.g., serviceId X).\\n2. Observe table shows filtered rows.\\n3. Map still shows every route instead of the single selected service.\\n\\n## Expected\\nMap layer filters to the scoped service(s) and highlights them, matching the table output.\\n\\n## Actual\\nMap still renders all routes; there is no filtering/fire update when the scope search result changes.\\n\\n## Context\\nLikely related to spatial query or table-state synchronization; map filters may not be re-applied when scope search updates the scoped service selection. Ensure MapLibre filter uses latest scope/service selection before rendering.\\n\\n## Dependencies\\n- Could involve NetworkView-3uh if scope search is reused there.","status":"open","priority":2,"issue_type":"bug","created_at":"2025-12-28T14:00:32.459953Z","updated_at":"2025-12-28T14:00:32.459953Z"}
{"id":"NetworkView-hr4","title":"Phase 2: Evidence strip visible","description":"Phase: Phase 2 — Map Viewer MVP (route lines + clip + filters + linked table) (5–10 days)\nSection: exports\nSource: plan.md\nDetails:\n- scope summary, filters, dataset version, definitions version","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-25T15:55:22.479283Z","updated_at":"2025-12-25T16:04:05.984636Z","labels":["phase-2"],"dependencies":[{"issue_id":"NetworkView-hr4","depends_on_id":"NetworkView-p57","type":"parent-child","created_at":"2025-12-25T16:04:06.519558Z","created_by":"daemon"}]}
{"id":"NetworkView-i4s","title":"Phase 2: Copy buttons for service_id/operator_code","description":"Phase: Phase 2 — Map Viewer MVP (route lines + clip + filters + linked table) (5–10 days)\nSection: inspector + drill-through\nSource: plan.md","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-25T15:55:21.979938Z","updated_at":"2025-12-25T16:04:07.564799Z","labels":["phase-2"],"dependencies":[{"issue_id":"NetworkView-i4s","depends_on_id":"NetworkView-p57","type":"parent-child","created_at":"2025-12-25T16:04:08.139209Z","created_by":"daemon"}]}
{"id":"NetworkView-iau","title":"Phase 1: Generate `routes.parquet` attribute table for DuckDB (same keys + richer columns)","description":"Phase: Phase 1 — Data artefacts v1 (PMTiles + Parquet) (3–7 days)\nSection: route lines\nSource: plan.md","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-25T15:55:16.93643Z","updated_at":"2025-12-25T16:09:36.939074Z","closed_at":"2025-12-25T16:09:36.939074Z","close_reason":"Closed","labels":["phase-1"],"dependencies":[{"issue_id":"NetworkView-iau","depends_on_id":"NetworkView-gjy","type":"parent-child","created_at":"2025-12-25T16:04:20.358805Z","created_by":"daemon"}]}
{"id":"NetworkView-jem","title":"SQ-03 Boundary definition options","description":"Scope\n- Provide boundary choice: radius buffer (v1), admin boundary (LA/RPT) if available.\n- Optional v1.1: polygon draw/lasso (if included, cap vertices + simplify).\n\nAcceptance\n- Selected admin boundary highlights and name shown.\n- Boundary selection updates visible overlay.\n","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-25T17:33:21.559986Z","updated_at":"2025-12-25T17:33:21.559986Z","dependencies":[{"issue_id":"NetworkView-jem","depends_on_id":"NetworkView-3uh","type":"parent-child","created_at":"2025-12-25T17:33:21.991167Z","created_by":"daemon"}],"comments":[{"id":16,"issue_id":"NetworkView-jem","author":"home","text":"Design mockup available at public/design/index.html (served at /design/). May need edits to align with spec before wiring into app.","created_at":"2025-12-25T21:52:33Z"},{"id":52,"issue_id":"NetworkView-jem","author":"home","text":"Validation note (2025-12-27): Ran Playwright on http://127.0.0.1:5137/. SQ panel opens and SLB controls are visible. 'Pick Point on Map' button present. No radius slider detected (input[type=range] count 0) and no visible Evidence text. Table rows remained 0 in my run, even after 'Load GeoJSON preview', so SQ execution/outputs could not be validated (map highlight, table restriction, CSV parity, evidence, edge cases). Screenshots in /tmp: sq-home.png, sq-panel.png, sq-validate-02-point.png, sq-validate-03-run.png, sq-sample-01-loaded.png, sq-sample-04-run.png. Please confirm data-populating environment for re-test.","created_at":"2025-12-27T19:46:56Z"}]}
{"id":"NetworkView-jgp","title":"Phase 2: MapLibre map with basemap style","description":"Phase: Phase 2 — Map Viewer MVP (route lines + clip + filters + linked table) (5–10 days)\nSection: map rendering\nSource: plan.md","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-25T15:55:18.034937Z","updated_at":"2025-12-25T16:04:17.411486Z","labels":["phase-2"],"dependencies":[{"issue_id":"NetworkView-jgp","depends_on_id":"NetworkView-p57","type":"parent-child","created_at":"2025-12-25T16:04:17.810042Z","created_by":"daemon"}]}
{"id":"NetworkView-k33","title":"Phase 4: Add caching headers + CDN rules for PMTiles/Parquet","description":"Phase: Phase 4 — Performance hardening + real time bands (as data allows) (ongoing)\nSource: plan.md","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-25T15:55:24.281759Z","updated_at":"2025-12-25T16:04:01.07443Z","labels":["phase-4"],"dependencies":[{"issue_id":"NetworkView-k33","depends_on_id":"NetworkView-zds","type":"parent-child","created_at":"2025-12-25T16:04:01.57053Z","created_by":"daemon"}]}
{"id":"NetworkView-k89","title":"Phase 2: Clip control","description":"Phase: Phase 2 — Map Viewer MVP (route lines + clip + filters + linked table) (5–10 days)\nSection: clipping\nSource: plan.md\nDetails:\n- choose LA by dropdown/search\n- choose RPT by dropdown/search","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-25T15:55:18.868202Z","updated_at":"2025-12-25T16:04:15.528403Z","labels":["phase-2"],"dependencies":[{"issue_id":"NetworkView-k89","depends_on_id":"NetworkView-p57","type":"parent-child","created_at":"2025-12-25T16:04:15.955765Z","created_by":"daemon"}]}
{"id":"NetworkView-k9r","title":"Phase 0: Create mono-repo structure","description":"Phase: Phase 0 — Repo + foundations (1–2 days)\nSource: plan.md\nDetails:\n- `apps/web` (Map Viewer UI)\n- `packages/data-pipeline` (scripts)\n- `data/` (local dev artefacts)","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-25T15:55:13.879984Z","updated_at":"2025-12-25T16:04:27.479599Z","closed_at":"2025-12-25T15:57:31.601326Z","labels":["phase-0"],"dependencies":[{"issue_id":"NetworkView-k9r","depends_on_id":"NetworkView-qnr","type":"parent-child","created_at":"2025-12-25T16:04:27.928754Z","created_by":"daemon"}]}
{"id":"NetworkView-kaz","title":"Phase 4: Add smoke tests","description":"Phase: Phase 4 — Performance hardening + real time bands (as data allows) (ongoing)\nSource: plan.md\nDetails:\n- “LA clip returns expected counts”\n- “Operator filter yields stable totals”\n\nAdditional scope: add lightweight diagnostic logging for key user actions and error paths so smoke tests can verify expected telemetry and failure modes.\n","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-25T15:55:24.749794Z","updated_at":"2025-12-25T16:38:36.33875Z","labels":["phase-4"],"dependencies":[{"issue_id":"NetworkView-kaz","depends_on_id":"NetworkView-zds","type":"parent-child","created_at":"2025-12-25T16:04:00.203036Z","created_by":"daemon"}]}
{"id":"NetworkView-kih","title":"Phase 2: Save “Map State” as JSON (local storage v1 is fine)","description":"Phase: Phase 2 — Map Viewer MVP (route lines + clip + filters + linked table) (5–10 days)\nSection: exports\nSource: plan.md","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-25T15:55:22.789673Z","updated_at":"2025-12-25T16:04:05.247239Z","labels":["phase-2"],"dependencies":[{"issue_id":"NetworkView-kih","depends_on_id":"NetworkView-p57","type":"parent-child","created_at":"2025-12-25T16:04:05.721433Z","created_by":"daemon"}]}
{"id":"NetworkView-ler","title":"Wire or hide non-functional tabs and layer toggles","description":"Header tabs (Map \u0026 Table / Insights / Reporting) and the Layers panel checkboxes are visible but have no wiring, which hurts trust and invites clicks that do nothing.\\n\\nContext:\\n- Header tab buttons in public/index.html are static; no data-tab bindings.\\n- Layers panel checkboxes in public/index.html are static; no listeners in public/app.js.\\n\\nAcceptance criteria:\\n- Either wire tabs/layer toggles to real behavior OR hide/disable them behind feature flags with \"Coming soon\" affordances.\\n- If disabled, use aria-disabled and tooltip copy explaining status.\\n\\nFiles:\\n- public/index.html\\n- public/app.js (if wiring)\\n- public/js/map/utils.js (if layer visibility handlers added)\\n","status":"open","priority":2,"issue_type":"bug","created_at":"2025-12-27T19:19:50.725983Z","updated_at":"2025-12-27T19:19:50.725983Z"}
{"id":"NetworkView-lko","title":"SQ-06 Map highlighting + dim non-matching routes","description":"Scope\n- Use match set to highlight routes and optionally dim non-matching.\n- Keep point/boundary overlays visible until cleared.\n\nAcceptance\n- Matches are visually distinct (thicker line/stronger color).\n- Optional toggle for dimming non-matching.\n","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-25T17:33:23.577142Z","updated_at":"2025-12-25T17:33:23.577142Z","dependencies":[{"issue_id":"NetworkView-lko","depends_on_id":"NetworkView-3uh","type":"parent-child","created_at":"2025-12-25T17:33:23.999143Z","created_by":"daemon"}],"comments":[{"id":54,"issue_id":"NetworkView-lko","author":"home","text":"Validation note (2025-12-27): Ran Playwright on http://127.0.0.1:5137/. SQ panel opens and SLB controls are visible. 'Pick Point on Map' button present. No radius slider detected (input[type=range] count 0) and no visible Evidence text. Table rows remained 0 in my run, even after 'Load GeoJSON preview', so SQ execution/outputs could not be validated (map highlight, table restriction, CSV parity, evidence, edge cases). Screenshots in /tmp: sq-home.png, sq-panel.png, sq-validate-02-point.png, sq-validate-03-run.png, sq-sample-01-loaded.png, sq-sample-04-run.png. Please confirm data-populating environment for re-test.","created_at":"2025-12-27T19:47:07Z"}]}
{"id":"NetworkView-mai","title":"Map filter wiring: pass tileFields into buildMapFilter","description":"buildMapFilter expects tileFields; app.js called it without tileFields, causing runtime crash when MapLibre idle fires.","acceptance_criteria":"applyMapFilters passes tileFields; detectTileFieldsFromRendered updates state; buildMapFilter guards missing tileFields; wiring test added.","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-12-25T20:07:48.750742Z","updated_at":"2025-12-25T20:08:38.278263Z","closed_at":"2025-12-25T20:08:38.278263Z","close_reason":"Closed","comments":[{"id":11,"issue_id":"NetworkView-mai","author":"home","text":"Fixed applyMapFilters to pass tileFields and persist detected tile fields; added buildMapFilter default param guard + wiring test update. Tests: npm test -- --run.","created_at":"2025-12-25T20:08:16Z"}]}
{"id":"NetworkView-oxq","title":"Improve spatial builder UI clarity and terminology","description":"Make the spatial query builder more intuitive by clarifying what Include/Exclude/Or Include actually do.\n\nIssues:\n- \"Additional Logic:\" label was unclear\n- Button labels didn't clearly indicate their boolean logic (AND/OR/NOT)\n- No explanation of how the refine operations work\n- Users unsure what each button does\n\nScope:\n- Rename \"Additional Logic:\" to something clearer\n- Change \"Also Include\" to better indicate OR logic\n- Add help tooltip explaining the three operations\n- Make summary text use plain English (AND, OR, BUT NOT)\n\nAcceptance:\n- Users understand what each button does without reading documentation\n- Clear distinction between Include (AND), Or Include (OR), and Exclude (NOT)\n- Help available on hover for quick reference","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-28T13:05:10.804783Z","updated_at":"2025-12-28T13:05:10.804783Z","labels":["spatial","ui","ux"]}
{"id":"NetworkView-p0f","title":"Phase 5: Consolidate State Management (Single Source of Truth)","description":"## Goal\n\nConsolidate 4 overlapping state objects into one canonical representation. This is HIGHER RISK - changes affect entire app.\n\n## Estimated Effort\n\n6-8 hours\n\n## Current Problem\n\n**4 Overlapping State Objects:**\n```javascript\n// state/manager.js\nstate.spatialBuilder      // Builder instance\nstate.spatialMatchSet     // Set\u003cstring\u003e\nstate.spatialQuery        // { active, serviceIds, point, pickingPoint }\n\n// builder.js (local)\nbuilder.state             // { find, condition, distance, blocks }\nbuilder.compiled          // Compiled query object\n```\n\n**Issues:**\n- State can drift out of sync\n- Unclear which is source of truth\n- Redundant data (serviceIds in both matchSet and spatialQuery)\n\n## What to Build\n\n### 1. Single State Object\n\n**In state/manager.js:**\n```javascript\nstate.spatial = {\n  // Query definition (user-editable, source of truth)\n  query: {\n    find: \"routes\",\n    condition: \"within\",\n    distance: 300,\n    target: \"selected_point\",\n    blocks: []\n  },\n\n  // Execution state\n  execution: {\n    status: \"idle\", // idle | validating | compiling | running | complete | error\n    serviceIds: [],\n    count: 0,\n    error: null,\n    lastRun: null,\n    executionTime: null,\n    metadata: null\n  },\n\n  // UI state (ephemeral)\n  ui: {\n    point: null,              // { lat, lng }\n    pickingPoint: false,\n    showBuilder: true,\n    activeTab: \"builder\"\n  },\n\n  // Metadata cache (from config)\n  metadata: {\n    operators: [],\n    modes: [],\n    boundaries: []\n  }\n};\n```\n\n### 2. Migration Strategy\n\n**Incremental Migration:**\n\n1. **Add new state structure** (alongside old)\n2. **Create getters/setters** that write to both old and new\n3. **Update consumers one at a time** to read from new\n4. **Remove old state** after all consumers migrated\n5. **Remove compatibility shims**\n\n**Phase 1: Add New State**\n```javascript\n// state/manager.js\nexport const initializeSpatialState = () =\u003e {\n  state.spatial = {\n    query: { /* defaults */ },\n    execution: { /* defaults */ },\n    ui: { /* defaults */ },\n    metadata: { /* defaults */ }\n  };\n};\n\n// Call during app init\ninitializeSpatialState();\n```\n\n**Phase 2: Compatibility Setters**\n```javascript\n// Write to both old and new (temporary)\nexport const setSpatialMatchSet = (matchSet) =\u003e {\n  // OLD (keep for now)\n  state.spatialMatchSet = matchSet;\n  state.spatialQuery = {\n    ...state.spatialQuery,\n    active: matchSet !== null,\n    serviceIds: matchSet ? Array.from(matchSet) : []\n  };\n  \n  // NEW\n  state.spatial.execution = {\n    ...state.spatial.execution,\n    status: matchSet ? \"complete\" : \"idle\",\n    serviceIds: matchSet ? Array.from(matchSet) : [],\n    count: matchSet ? matchSet.size : 0\n  };\n};\n```\n\n**Phase 3: Update Consumers**\n```javascript\n// Find all readers of old state\ngrep -rn \"state\\.spatialMatchSet\" public/\ngrep -rn \"state\\.spatialQuery\" public/\ngrep -rn \"state\\.spatialBuilder\" public/\n\n// Update each to read from state.spatial\n// OLD\nconst ids = state.spatialQuery.serviceIds;\n\n// NEW\nconst ids = state.spatial.execution.serviceIds;\n```\n\n**Phase 4: Remove Old State**\n```javascript\n// After all consumers migrated, remove:\n// - state.spatialBuilder\n// - state.spatialMatchSet\n// - state.spatialQuery\n\n// Keep only:\n// - state.spatial\n```\n\n### 3. State Setters (New API)\n\n```javascript\n// Query setters\nexport const setSpatialQuery = (query) =\u003e {\n  state.spatial.query = { ...state.spatial.query, ...query };\n};\n\n// Execution setters\nexport const setSpatialExecution = (execution) =\u003e {\n  state.spatial.execution = { ...state.spatial.execution, ...execution };\n};\n\nexport const setSpatialStatus = (status) =\u003e {\n  state.spatial.execution.status = status;\n};\n\nexport const setSpatialResults = (serviceIds) =\u003e {\n  state.spatial.execution = {\n    ...state.spatial.execution,\n    status: \"complete\",\n    serviceIds,\n    count: serviceIds.length,\n    lastRun: new Date().toISOString()\n  };\n};\n\n// UI setters\nexport const setSpatialPoint = (point) =\u003e {\n  state.spatial.ui.point = point;\n};\n\nexport const setSpatialPickingPoint = (picking) =\u003e {\n  state.spatial.ui.pickingPoint = picking;\n};\n\n// Metadata setter\nexport const setSpatialMetadata = (metadata) =\u003e {\n  state.spatial.metadata = metadata;\n};\n```\n\n### 4. Service Integration\n\n**Update SpatialQueryService to use new state:**\n```javascript\n// Before\nthis.state.spatial.query = query;\nthis.state.spatial.execution = { ... };\n\n// Same, but now it's the ONLY state\n```\n\n**Remove compatibility adapter:**\n```javascript\n// spatial/compatibility/adapter.js\n// DELETE this file after migration complete\n```\n\n## Refactoring Practices\n\n**CRITICAL - Follow AGENTS.md:**\n\n1. **Backup before starting:**\n   ```bash\n   cp public/js/state/manager.js /tmp/state_manager_backup.js\n   ```\n\n2. **Find ALL state readers:**\n   ```bash\n   # Comprehensive search\n   grep -rn \"state\\.spatial\" public/\n   grep -rn \"state\\.spatialBuilder\" public/\n   grep -rn \"state\\.spatialMatchSet\" public/\n   grep -rn \"state\\.spatialQuery\" public/\n   \n   # Create a checklist\n   # Update each one, check off when done\n   ```\n\n3. **Update incrementally:**\n   ```bash\n   # 1. Add new state structure\n   # 2. Add compatibility setters\n   # 3. Update one consumer at a time\n   # 4. Test after EACH update\n   npm test\n   # Check browser console\n   ```\n\n4. **Verify no drift:**\n   ```javascript\n   // Add assertion during migration\n   if (state.spatial \u0026\u0026 state.spatialQuery) {\n     const newCount = state.spatial.execution.count;\n     const oldCount = state.spatialQuery.serviceIds.length;\n     if (newCount !== oldCount) {\n       console.error(\"[STATE DRIFT]\", { new: newCount, old: oldCount });\n     }\n   }\n   ```\n\n5. **Git commits (atomic):**\n   ```bash\n   git add public/js/state/manager.js\n   git commit -m \"Add unified spatial state structure\n   \n   - Single state.spatial object\n   - Replaces 4 overlapping objects\n   - Includes query, execution, ui, metadata\n   - Compatibility setters write to both old and new\"\n   \n   git add public/app.js\n   git commit -m \"Update app.js to read from unified spatial state\n   \n   - Read from state.spatial instead of old objects\n   - Compatibility setters still write to both\n   - No breaking changes\"\n   \n   git add public/js/spatial/\n   git commit -m \"Update spatial modules to use unified state\n   \n   - Service uses state.spatial\n   - UI uses state.spatial.ui\n   - Remove direct access to old objects\"\n   \n   git add public/js/state/manager.js\n   git commit -m \"Remove old spatial state objects\n   \n   - Delete state.spatialBuilder\n   - Delete state.spatialMatchSet\n   - Delete state.spatialQuery\n   - Only state.spatial remains\n   - Remove compatibility setters\"\n   ```\n\n## Testing Strategy\n\n**State Migration Tests:**\n```javascript\n// tests/spatial-state-migration.test.js\ndescribe(\"Spatial State Migration\", () =\u003e {\n  it(\"should have single spatial state object\", () =\u003e {\n    expect(state.spatial).toBeDefined();\n    expect(state.spatial.query).toBeDefined();\n    expect(state.spatial.execution).toBeDefined();\n    expect(state.spatial.ui).toBeDefined();\n  });\n  \n  it(\"should update execution state correctly\", () =\u003e {\n    setSpatialResults([\"id1\", \"id2\"]);\n    \n    expect(state.spatial.execution.status).toBe(\"complete\");\n    expect(state.spatial.execution.serviceIds).toEqual([\"id1\", \"id2\"]);\n    expect(state.spatial.execution.count).toBe(2);\n  });\n  \n  it(\"should not have old state objects\", () =\u003e {\n    expect(state.spatialBuilder).toBeUndefined();\n    expect(state.spatialMatchSet).toBeUndefined();\n    expect(state.spatialQuery).toBeUndefined();\n  });\n});\n```\n\n**Integration Tests:**\n```javascript\n// Verify no state drift\nit(\"should maintain state consistency across operations\", async () =\u003e {\n  const service = new SpatialQueryService({ state, eventBus, db });\n  \n  await service.executeQuery(query);\n  \n  // Check state is consistent\n  const { serviceIds, count } = state.spatial.execution;\n  expect(serviceIds.length).toBe(count);\n  \n  // No old state exists\n  expect(state.spatialMatchSet).toBeUndefined();\n});\n```\n\n## Acceptance Criteria\n\n- [ ] state.spatial object created with query/execution/ui/metadata\n- [ ] All spatial modules use state.spatial\n- [ ] Old state objects removed (spatialBuilder, spatialMatchSet, spatialQuery)\n- [ ] No state drift (verified with tests)\n- [ ] All state readers updated (grep shows none reading old objects)\n- [ ] All state writers updated (setters use new API)\n- [ ] Compatibility adapter removed\n- [ ] Tests passing (state migration tests + existing tests)\n- [ ] Browser console shows no errors\n- [ ] Committed and pushed\n\n## Call Site Verification Checklist\n\nCreate checklist of all files to update:\n\n```bash\n# Generate checklist\ngrep -rn \"state\\.spatialBuilder\\|state\\.spatialMatchSet\\|state\\.spatialQuery\" public/ | \\\n  cut -d: -f1 | sort -u \u003e /tmp/spatial_state_files.txt\n\n# Files to update (example):\n# [ ] public/app.js\n# [ ] public/js/filters/builder.js\n# [ ] public/js/spatial/builder.js\n# [ ] public/js/spatial/execute.js\n# [ ] public/js/spatial/evidence.js\n```\n\n## Performance Validation\n\n**Verify no performance regression:**\n```javascript\n// Before and after migration\nconsole.time(\"query-execution\");\nawait service.executeQuery(query);\nconsole.timeEnd(\"query-execution\");\n\n// Should be similar or better\n```\n\n## References\n\nSPATIAL_ARCHITECTURE_REVIEW.md section: \"Single State Object\"\nAGENTS.md section: \"Comprehensive Call Site Auditing\"\n\n## Parent Epic\n\nNetworkView-p5s\n\n## Depends On\n\nNetworkView-eij (Phase 1), NetworkView-94q (Phase 2), NetworkView-5tx (Phase 3), NetworkView-cni (Phase 4)","status":"open","priority":1,"issue_type":"task","created_at":"2025-12-28T20:19:40.221019Z","updated_at":"2025-12-28T20:19:40.221019Z","labels":["refactoring","spatial","state-management"]}
{"id":"NetworkView-p57","title":"Epic: Phase 2 — Map Viewer MVP (route lines + clip + filters + linked table) (5–10 days)","description":"Goal: a planner can find a place, clip to LA/RPT, filter routes, inspect, and export a CSV.\nDeliverables:\n- Map Viewer usable end-to-end for route lines\n- CSV export working\n- Evidence strip present\nAcceptance:\n- User can:\n- Table row count matches the map feature set under the same filters (within defined rules)\nSource: plan.md","status":"in_progress","priority":1,"issue_type":"epic","created_at":"2025-12-25T16:03:57.402197Z","updated_at":"2025-12-25T16:39:18.312969Z","labels":["phase-2"]}
{"id":"NetworkView-p57.1","title":"Phase 2: Virtualised table follow-ups (row height + paging)","description":"Context\\n- Data Inspector table uses scroll-window virtualisation (spacer rows + visible slice) and a configurable tableLimit (default 2000).\\n\\nProblems\\n- Virtualisation assumes fixed row height; style/font changes can desync scroll math.\\n- Large selections still need paging/offset or adaptive limits to avoid heavy single-shot DuckDB queries.\\n\\nAcceptance\\n- Measure row height dynamically (at least once per render) to keep spacer math accurate.\\n- Add paging (LIMIT/OFFSET) or adaptive tableLimit based on selection size/device to keep UI responsive for \u003e10k rows.\\n- Selection, keyboard nav, and exports/evidence remain consistent under paging/virtualisation.\\n\\nImplementation notes\\n- Files: public/app.js (renderTable + queryTable).\\n- Consider adding a per-query cache keyed by filter state to avoid requerying on scroll.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-25T16:25:48.888583Z","updated_at":"2025-12-25T16:41:41.953551Z","closed_at":"2025-12-25T16:41:41.953551Z","close_reason":"Closed","labels":["phase-2"],"dependencies":[{"issue_id":"NetworkView-p57.1","depends_on_id":"NetworkView-p57","type":"parent-child","created_at":"2025-12-25T16:25:48.889828Z","created_by":"home"},{"issue_id":"NetworkView-p57.1","depends_on_id":"NetworkView-6rf","type":"parent-child","created_at":"2025-12-25T16:38:21.810206Z","created_by":"daemon"}],"comments":[{"id":2,"issue_id":"NetworkView-p57.1","author":"home","text":"Completed: added dynamic row height measurement (measures first rendered row and adjusts virtual rowHeight), and added paging (LIMIT/OFFSET) with lazy page fetch based on scroll position. Added browse cap disclosure in evidence/table meta and made tableLimit/pageSize/browseMax configurable (config.tableLimit/tablePageSize/tableBrowseMax). Updated selection click handling to work under paging. Files: public/app.js, public/config.json, public/config.sample.json, public/config.r2.json.","created_at":"2025-12-25T16:41:20Z"}]}
{"id":"NetworkView-p5s","title":"Spatial Query Module: Architectural Refactoring","description":"## Problem Statement\n\nCurrent spatial module has architectural brittleness where \"every fix breaks something.\" \n\n**Core Issues:**\n- Unclear separation of concerns (builder.js does UI + logic + state)\n- Complex state dependencies (4 overlapping state objects)\n- Tight coupling to global state\n- Missing validation layer\n- Brittle integration points\n- Execution flow confusion\n\n**Impact:**\n- Development friction (unpredictable time to add features)\n- High regression rate (~40% of changes break existing features)\n- Difficult to test (modules depend on global state, DOM)\n- Blocks SLB epic (NetworkView-1tt)\n\n## Solution\n\nRefactor to layered architecture with clear separation of concerns:\n\n**Layers:**\n```\nPresentation (UI only) → Application (orchestration) → Domain (pure logic) → Infrastructure (SQL/DB)\n```\n\n**7 Key Principles:**\n1. Clear layer separation\n2. Single source of truth (one state.spatial object)\n3. Unidirectional data flow\n4. Dependency inversion (inject dependencies, not global access)\n5. Explicit execution model (cancellable, versioned queries)\n6. Strong validation (fail fast at boundaries)\n7. Loose coupling via events (fan-out only, not core logic)\n\n**Architecture Decisions:**\n- Controlled impurity accepted at boundaries (spatial rules need context)\n- Cancellation support - \"latest result wins\" for concurrent edits\n- Query caching - hash-based cache for performance\n- Versioned contracts - compiled queries are stable, serializable\n- Events for side effects only - core execution stays synchronous/debuggable\n\n## Approach\n\n**Parallel Operation Strategy:**\n- No big-bang rewrite\n- Run old and new architecture side-by-side\n- Feature flag: config.features.spatial_new_architecture\n- Compatibility shims for gradual cutover\n- Comprehensive testing at each phase\n- Only remove old code after new is proven\n\n## Success Metrics\n\n**Architectural Health:**\n- Coupling: \u003c20% modules with global state access (currently ~80%)\n- Test Coverage: \u003e90% (currently ~50%)\n- Cyclomatic Complexity: \u003c10 per function (builder.js has \u003e15)\n\n**Developer Experience:**\n- Time to add feature: \u003c2h (currently unpredictable)\n- Regression rate: \u003c10% (currently ~40%)\n\n## References\n\n- SPATIAL_ARCHITECTURE_REVIEW.md - Complete architectural analysis\n- AGENTS.md - Refactoring guidelines\n- plan.md - Discovery log\n\n## Phases\n\nSee child tasks for detailed phase breakdown (6 phases, 34-48h total)","status":"open","priority":1,"issue_type":"epic","created_at":"2025-12-28T19:35:29.201596Z","updated_at":"2025-12-28T19:35:29.201596Z"}
{"id":"NetworkView-qk1","title":"SLB-05 Exclude operators/modes","description":"Scope\n- Implement Exclude blocks for operator + mode.\n- Apply exclusions after include blocks.\n\nAcceptance\n- Excluding operator/mode removes routes from map/table.\n","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-25T20:58:10.099702Z","updated_at":"2025-12-25T20:58:10.099702Z","dependencies":[{"issue_id":"NetworkView-qk1","depends_on_id":"NetworkView-1tt","type":"parent-child","created_at":"2025-12-25T20:58:10.524474Z","created_by":"daemon"}]}
{"id":"NetworkView-qle","title":"Map misses scope-selected service","description":"## Summary\nSelecting a specific service via the scope search updates the results table correctly, but the map still renders the full dataset instead of highlighting the scoped service. The UI needs to keep the map and table in sync when scope search restricts to one service.\n\n## Steps to Reproduce\n1. Run scope search for a known service (e.g., serviceId X).\n2. Observe table shows filtered rows.\n3. Map still shows every route instead of the single selected service.\n\n## Expected\nMap layer filters to the scoped service(s) and highlights them, matching the table output.\n\n## Actual\nMap still renders all routes; there is no filtering/fire update when the scope search result changes.\n\n## Context\nLikely related to spatial query or table-state synchronization; map filters may not be re-applied when scope search updates . Ensure MapLibre filter uses latest scope/service selection before rendering.\n\n## Dependencies\n- Possibly ties into NetworkView-3uh if scope search is reused there.","status":"open","priority":2,"issue_type":"bug","created_at":"2025-12-28T14:00:31.104942Z","updated_at":"2025-12-28T14:00:31.104942Z"}
{"id":"NetworkView-qn3","title":"Phase 4: Convert large layers to multiple PMTiles by theme if needed","description":"Phase: Phase 4 — Performance hardening + real time bands (as data allows) (ongoing)\nSource: plan.md","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-25T15:55:24.024922Z","updated_at":"2025-12-25T16:04:01.803779Z","labels":["phase-4"],"dependencies":[{"issue_id":"NetworkView-qn3","depends_on_id":"NetworkView-zds","type":"parent-child","created_at":"2025-12-25T16:04:02.290408Z","created_by":"daemon"}]}
{"id":"NetworkView-qnr","title":"Epic: Phase 0 — Repo + foundations (1–2 days)","description":"Goal: establish a working shell and tooling.\nDeliverables:\n- Running local web app scaffold with placeholder layout\n- Config files committed\nAcceptance:\n- `pnpm dev` (or `npm run dev`) launches app and renders a placeholder map container and table container\nSource: plan.md","status":"open","priority":1,"issue_type":"epic","created_at":"2025-12-25T16:03:56.886524Z","updated_at":"2025-12-25T16:03:56.886524Z","labels":["phase-0"]}
{"id":"NetworkView-rkd","title":"When a place is found via geocoder the pin in the map does not match the rest of the UI and does dot clear when filter state is reset","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-12-25T23:11:08.041129Z","updated_at":"2025-12-25T23:48:17.973964Z","closed_at":"2025-12-25T23:48:17.974157Z","comments":[{"id":39,"issue_id":"NetworkView-rkd","author":"home","text":"Synced geocoder selection with spatial point overlay/label and added geocoder marker cleanup on filter reset (also clears place search UI). Files: public/app.js. Tests: npm test.","created_at":"2025-12-25T23:47:41Z"}]}
{"id":"NetworkView-rsf","title":"Phase 3: MapBuilder shows the same view and allows","description":"Phase: Phase 3 — Snapshot export + MapBuilder hand-off (3–7 days)\nSection: MapBuilder scaffold (minimal)\nSource: plan.md\nDetails:\n- title/subtitle edits\n- annotation text box (simple)\n- export again","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-25T15:55:23.783328Z","updated_at":"2025-12-25T16:04:02.521948Z","labels":["phase-3"],"dependencies":[{"issue_id":"NetworkView-rsf","depends_on_id":"NetworkView-wu5","type":"parent-child","created_at":"2025-12-25T16:04:03.015143Z","created_by":"daemon"}]}
{"id":"NetworkView-ruy","title":"Phase 2 - console log","description":"add in console log that records appropriate details of user actions. and prints relevant errors for diagnosis","notes":"Investigated LA/RPT filter issue; MapLibre tile filter now coerces LA/RPT codes to strings when matching (commit on phase-3-integration).","status":"closed","priority":2,"issue_type":"feature","created_at":"2025-12-25T16:17:32.720598Z","updated_at":"2025-12-25T20:43:11.514078Z","closed_at":"2025-12-25T17:14:24.236963Z"}
{"id":"NetworkView-u7q","title":"Phase 2: Display active boundary outline and name","description":"Phase: Phase 2 — Map Viewer MVP (route lines + clip + filters + linked table) (5–10 days)\nSection: clipping\nSource: plan.md","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-25T15:55:19.40238Z","updated_at":"2025-12-25T16:04:14.233842Z","labels":["phase-2"],"dependencies":[{"issue_id":"NetworkView-u7q","depends_on_id":"NetworkView-p57","type":"parent-child","created_at":"2025-12-25T16:04:14.638504Z","created_by":"daemon"}]}
{"id":"NetworkView-ubc","title":"Improve spatial query coverage and relation controls","description":"## Summary\\nSpatial queries are still missing services outside the local area (e.g., Aberdeen returns only 65 routes, dropping long-distance coach services) and the UI only lets you pick a point+radius; there is no way to choose whether the query should intersect, contain, or follow another relation. We need a more dataset-agnostic spatial filter experience that surfaces the right results for coast-to-coast services and gives users control over the relation.\\n\\n## Acceptance Criteria\\n- Spatial queries return the expected set of services even when the radius spans large areas (e.g., Aberdeen example should include long-distance coaches once filters are configured appropriately).\\n- Builder UI exposes a dropdown (or similar control) to choose the spatial relation for each block (intersect/within/contains/touches), with a clear label that isn’t tied to routes, and updates the compiled state accordingly.\\n- Query generator honors the selected relation when building DuckDB SQL, including geometry and bbox fallbacks, so the backend can handle intersect/within/contain/touch without leaking route-specific terms.\\n- Document the new choices in the viewer help text so users know what each relation does and how it affects long-distance matches.\\n\\n## Dependencies\\n- Depends on NetworkView-3uh (Spatial Query Tool epic)","status":"open","priority":2,"issue_type":"feature","created_at":"2025-12-28T10:05:55.604207Z","updated_at":"2025-12-28T10:05:55.604207Z"}
{"id":"NetworkView-ucr","title":"SQ-05 Query execution (DuckDB) + service_id match set","description":"Scope\n- Compute matching service_id list from point/boundary/logic.\n- Decide v1 method (bbox/radius approximation vs geometry ST_DWithin/ST_Intersects).\n- Return match set for map + table.\n\nAcceptance\n- Typical city-scale query completes ~1–2s.\n- No full-page re-render or jank.\n\nNotes\n- v1 likely: bbox/radius approximation; v1.1: true geometry refine.\n","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-25T17:33:22.908094Z","updated_at":"2025-12-25T17:33:22.908094Z","dependencies":[{"issue_id":"NetworkView-ucr","depends_on_id":"NetworkView-3uh","type":"parent-child","created_at":"2025-12-25T17:33:23.359876Z","created_by":"daemon"}],"comments":[{"id":53,"issue_id":"NetworkView-ucr","author":"home","text":"Validation note (2025-12-27): Ran Playwright on http://127.0.0.1:5137/. SQ panel opens and SLB controls are visible. 'Pick Point on Map' button present. No radius slider detected (input[type=range] count 0) and no visible Evidence text. Table rows remained 0 in my run, even after 'Load GeoJSON preview', so SQ execution/outputs could not be validated (map highlight, table restriction, CSV parity, evidence, edge cases). Screenshots in /tmp: sq-home.png, sq-panel.png, sq-validate-02-point.png, sq-validate-03-run.png, sq-sample-01-loaded.png, sq-sample-04-run.png. Please confirm data-populating environment for re-test.","created_at":"2025-12-27T19:47:02Z"},{"id":60,"issue_id":"NetworkView-ucr","author":"home","text":"timestamp refresh","created_at":"2025-12-28T09:11:41Z"}]}
{"id":"NetworkView-v9p","title":"Multi-select defaults filter table to (none); map/table out of sync","description":"Repro: load app with metadata-driven multi-select filters (Mode/Operator). Browser auto-selects the first option, which is '(none)', causing buildWhere() to apply an unknown-only filter =\u003e queryCount returns 0 and Data Inspector shows 'Rows 0–0 of 0' even though routes render on the map.\n\nAlso: changing Mode/Operator/LA/RPT/Time band should immediately apply filters (map + table), but only some controls auto-apply today.\n\nExpected: On first load, no filter is applied by default (multi-selects start with no selection), initial table loads all routes, and changing any filter control updates the map/table consistently.","acceptance_criteria":"- Fresh load shows non-zero selection/table when data exists.\n- Multi-selects start with no selected option.\n- Changing Mode/Operator/LA/RPT/Time band applies map+table filters (debounced) without requiring the Apply button.\n- No console errors from rapid filter changes.","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-12-25T17:15:31.11326Z","updated_at":"2025-12-25T17:16:25.847083Z","closed_at":"2025-12-25T17:16:25.847083Z","close_reason":"Closed","labels":["phase-2","regression","ui"],"comments":[{"id":3,"issue_id":"NetworkView-v9p","author":"home","text":"Implemented fix in public/app.js: clear default selections for multi-selects after fillSelect() so (none) is not auto-selected on load; add debounced change listeners for Mode/Operator/Time band/LA/RPT to call onApplyFilters(); add state.applyingFilters guard to coalesce rapid apply calls. Ran: node --check public/app.js.","created_at":"2025-12-25T17:16:12Z"}]}
{"id":"NetworkView-wgy","title":"Clarify filter apply model (auto-apply vs Apply button)","description":"The UI presents an explicit \"Apply filters\" action, but filters auto-apply on change (debounced) for most controls. This creates a split mental model and makes it unclear when changes are live.\\n\\nContext:\\n- Auto-apply debounce in public/app.js (filter change bindings).\\n- Apply button + Reset visible in public/index.html Actions section.\\n\\nAcceptance criteria:\\n- Decide and document one model (explicit apply OR auto-apply) and align UI copy/behavior.\\n- If auto-apply: rename button to \"Re-run\" or \"Apply now\" and add an \"Auto\" indicator or toggle; add a brief hint near Actions.\\n- If manual apply: remove debounce auto-apply and show a \"pending changes\" indicator.\\n- Update status/preview messaging to match the chosen model.\\n\\nFiles:\\n- public/index.html\\n- public/app.js\\n","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-27T19:19:32.968697Z","updated_at":"2025-12-27T19:19:32.968697Z"}
{"id":"NetworkView-wrn","title":"SQ-01 UI shell + state for spatial query","description":"Scope\n- Add Spatial Query panel under Scope with collapsed default.\n- Add map toolbar (Place point, Draw boundary, Logic, Run, Clear).\n- Define client state model for point, radius, boundary, logic, results.\n\nAcceptance\n- Panel opens/closes without breaking existing filters.\n- Tool can be toggled on/off and reset/clear.\n- State persists during session and restores previous view when cleared.\n\nFiles\n- public/index.html, public/styles.css, public/app.js\n","notes":"UI shell complete: full builder panel added to index.html with Builder/Templates tabs, Find/That/Dist/Of controls, block system with Include/Also Include/Exclude pills, plain-English summary, point picker button, Clear/Run actions. State management in place via spatial/builder.js (438 lines). Feature flag spatialQuery enabled in config files. Execution pipeline still pending (runner is stub).","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-25T17:33:20.101343Z","updated_at":"2025-12-26T10:38:03.83541Z","closed_at":"2025-12-26T10:38:03.835733Z","dependencies":[{"issue_id":"NetworkView-wrn","depends_on_id":"NetworkView-3uh","type":"parent-child","created_at":"2025-12-25T17:33:20.635074Z","created_by":"daemon"}],"comments":[{"id":15,"issue_id":"NetworkView-wrn","author":"home","text":"Design mockup available at public/design/index.html (served at /design/). May need edits to align with spec before wiring into app.","created_at":"2025-12-25T21:52:32Z"}]}
{"id":"NetworkView-wu5","title":"Epic: Phase 3 — Snapshot export + MapBuilder hand-off (3–7 days)","description":"Goal: create report-ready visuals without GIS.\nDeliverables:\n- Report-ready PNG export\n- Evidence note copy feature\n- Minimal MapBuilder that reuses Viewer state\nAcceptance:\n- Exported PNG can be dropped into a Word report and is self-explanatory without additional context\n- Evidence note can be pasted into an appendix and matches the export scope\nSource: plan.md","status":"open","priority":1,"issue_type":"epic","created_at":"2025-12-25T16:03:57.646405Z","updated_at":"2025-12-25T16:03:57.646405Z","labels":["phase-3"]}
{"id":"NetworkView-wuk","title":"Implement dynamic operator/mode dropdowns in spatial builder","description":"Replace hardcoded operator/mode dropdown values with dynamic population from state.metadata.\n\nScope:\n- Pull actual operators from state.metadata.operators\n- Pull actual modes from state.metadata.modes  \n- Normalize data formats to handle both string arrays and object arrays\n- Rebuild dropdowns when switching between operator/mode types\n- Add fallback values for when metadata hasn't loaded yet\n\nAcceptance:\n- Exclude block value dropdowns show real operators/modes from loaded dataset\n- Dropdowns update dynamically when switching between \"by Operator\" and \"by Mode\"\n- No hardcoded operator/mode lists remain in builder code\n- Console logging helps debug metadata loading timing issues\n\nIntegration notes:\n- Uses same normalization logic as app.js for consistency\n- Mirrors operator/mode data structures used elsewhere in application","notes":"Implemented dynamic operator/mode dropdown population in spatial query builder.\n\nChanges made to public/js/spatial/builder.js:\n\n1. Added state import:\n   - import { state, setSpatialBuilder } from \"../state/manager.js\"\n\n2. Added data normalization functions (mirroring app.js logic):\n   - normalizeModes(raw) - handles both string arrays and object arrays\n   - normalizeOperators(raw) - extracts code/label from various formats\n\n3. Added metadata accessor functions:\n   - getAvailableOperators() - pulls from state.metadata.operators with fallback\n   - getAvailableModes() - pulls from state.metadata.modes with fallback\n   - Both include console logging for debugging\n\n4. Created dynamic dropdown builder:\n   - buildValueSelectOptions(operatorType) - generates HTML for operator/mode select\n   - Handles both operator objects {code, label} and plain mode strings\n   - Includes placeholder \"Select operator/mode...\" option\n\n5. Updated getOperatorOptions():\n   - Exclude blocks now use buildValueSelectOptions(currentOperator)\n   - Dynamically rebuilds based on whether operator or mode is selected\n\n6. Enhanced operator change handler:\n   - Detects when switching between \"operator\" and \"mode\" types\n   - Rebuilds value dropdown with appropriate data\n   - Resets value when switching types to prevent stale selections\n\nFiles modified:\n- public/js/spatial/builder.js (lines 1-200+)\n\nTesting:\n- Syntax verified with node -c command\n- Console logs added for metadata loading debugging\n- Fallback values ensure UI works even if metadata loads slowly\n\nImplementation complete and ready for browser testing.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-28T13:04:48.727071Z","updated_at":"2025-12-28T13:05:01.093096Z","closed_at":"2025-12-28T13:05:01.093108Z","labels":["spatial","task","ui"]}
{"id":"NetworkView-x76","title":"Phase 2: Mode filter (multi-select)","description":"Phase: Phase 2 — Map Viewer MVP (route lines + clip + filters + linked table) (5–10 days)\nSection: filtering\nSource: plan.md","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-25T15:55:19.654832Z","updated_at":"2025-12-25T16:04:13.630735Z","labels":["phase-2"],"dependencies":[{"issue_id":"NetworkView-x76","depends_on_id":"NetworkView-p57","type":"parent-child","created_at":"2025-12-25T16:04:14.029249Z","created_by":"daemon"}]}
{"id":"NetworkView-yas","title":"Phase 2: Time band filter (enabled if flags exist, otherwise disabled with “coming soon”)","description":"Phase: Phase 2 — Map Viewer MVP (route lines + clip + filters + linked table) (5–10 days)\nSection: filtering\nSource: plan.md","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-25T15:55:20.410612Z","updated_at":"2025-12-25T16:47:08.615031Z","closed_at":"2025-12-25T16:47:08.615035Z","labels":["phase-2"],"dependencies":[{"issue_id":"NetworkView-yas","depends_on_id":"NetworkView-p57","type":"parent-child","created_at":"2025-12-25T16:04:12.12606Z","created_by":"daemon"}]}
{"id":"NetworkView-zds","title":"Epic: Phase 4 — Performance hardening + real time bands (as data allows) (ongoing)","description":"Goal: make the existing `public/` UI “real” (filters → map → table → inspector → exports) without introducing a bundler yet.\nAcceptance:\n- Viewer remains responsive with Scotland-wide view and typical filters\n- Time band filter behaviour is correct and disclosed in Evidence\nSource: plan.md","status":"open","priority":1,"issue_type":"epic","created_at":"2025-12-25T16:03:57.920182Z","updated_at":"2025-12-25T16:03:57.920182Z","labels":["phase-4"]}
